<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>چت‌بات BK JS پیشرفته</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --user-message-bg: #e3f2fd;
            --bot-message-bg: #f1f0f0;
            --font-family: "Vazirmatn", "Tanha", "Segoe UI", Tahoma, sans-serif;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .message {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: 1rem;
            animation: fadeIn 0.3s ease;
            position: relative;
        }
        
        .user-message {
            align-self: flex-end;
            background-color: var(--user-message-bg);
            border-bottom-right-radius: 0.25rem;
        }
        
        .bot-message {
            align-self: flex-start;
            background-color: var(--bot-message-bg);
            border-bottom-left-radius: 0.25rem;
        }
        
        .message-time {
            font-size: 0.7rem;
            color: var(--secondary-color);
            margin-top: 0.25rem;
            text-align: right;
        }
        
        .input-container {
            display: flex;
            padding: 1rem;
            background-color: white;
            border-top: 1px solid #ddd;
        }
        
        #userInput {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 1.5rem;
            font-family: var(--font-family);
            outline: none;
        }
        
        #sendBtn {
            margin-right: 0.5rem;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 1.5rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #sendBtn:hover {
            background-color: #3a5a80;
        }
        
        .typing-indicator {
            display: none;
            align-self: flex-start;
            background-color: var(--bot-message-bg);
            padding: 0.75rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }
        
        .typing-dot {
            width: 0.5rem;
            height: 0.5rem;
            background-color: var(--secondary-color);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
</head>
<body>
    <div class="header">
        <h1>چت‌بات BK JS - نسخه پیشرفته</h1>
        <p>با قابلیت درک بهتر مکالمات</p>
    </div>
    
    <div class="chat-container" id="chatContainer">
        <div class="message bot-message">
            سلام! من BK JS هستم، چت‌بات پیشرفته. چطور می‌تونم کمکتون کنم؟
            <div class="message-time">همین الان</div>
        </div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    </div>
    
    <div class="input-container">
        <input type="text" id="userInput" placeholder="پیام خود را بنویسید...">
        <button id="sendBtn">ارسال</button>
    </div>

    <script>
        // ====== ابر BK JS – نسخه پیشرفته و حرفه‌ای ======
        const keywordsDB = {
            greeting: ["سلام", "درود", "هی", "صبح بخیر", "عصر بخیر", "شب بخیر", "خوش آمدی", "احوالپرسی", "چطوری", "حالت", "وقت بخیر", "سلامتی", "hello", "hi", "hey", "good morning", "good night", "چه خبر", "خوبی", "خوشوقتم", "چخبر", "حالتون", "چطورید", "خوش اومدی"],
            personal: ["چند سالته", "اسمت", "نام", "اهل کجایی", "شغل", "تحصیل", "رشته", "زبان", "خانواده", "تولد", "محل زندگی", "ملیت", "اقامت", "name", "age", "job", "study", "کار", "کارمی کنی", "مشغولیت", "سن", "سال داری", "کجا زندگی می کنی", "خاستگاه", "اصالت", "شهر", "کشور", "محل تولد"],
            weather: ["هوا", "باران", "برف", "آفتابی", "ابری", "دما", "گرما", "سرما", "فصل", "باد", "خورشید", "طوفان", "رطوبت", "مه", "weather", "rain", "snow", "sunny", "cloudy", "temperature", "آب و هوا", "وضعیت هوا", "هواشناسی", "سرد", "گرم", "معتدل", "مرطوب", "خشک", "بارانی", "برفی", "پربارش", "آسمان", "ابر", "تابش", "اشعه"],
            daily: ["برنامه", "کار", "روز", "امروز", "فردا", "هفته", "ماه", "سال", "روتین", "صبح", "شب", "هدف", "وظیفه", "تکلیف", "plan", "work", "day", "today", "tomorrow", "برنامه روزانه", "برنامه هفتگی", "برنامه آینده", "طرح", "پروژه", "ماموریت", "کارهای روزمره", "عادت", "شیوه زندگی", "برنامه ریزی", "طرح ریزی", "هدف گذاری"],
            fun: ["جوک", "خنده", "معما", "فان", "سرگرمی", "میم", "طنز", "سرگرم‌کننده", "joke", "fun", "riddle", "meme", "طنز", "لطیفه", "شوخی", "مزاح", "بازی", "تفریح", "سرگرم کننده", "خنده دار", "خوشگذرانی", "فراغت", "اوقات فراغت", "تفنن", "مفرح", "مسخره", "خندیدن", "قهقهه"],
            tech: ["کامپیوتر", "گوشی", "موبایل", "اینترنت", "AI", "هوش مصنوعی", "بازی", "ربات", "تکنولوژی", "اپلیکیشن", "نرم افزار", "computer", "phone", "internet", "ai", "technology", "app", "فناوری", "رایانه", "تلفن همراه", "برنامه", "نرم افزار", "سخت افزار", "الگوریتم", "داده", "برنامه نویسی", "کدنویسی", "یادگیری ماشین", "دیتا", "هک", "امنیت", "شبکه", "ارتباطات"],
            emotions: ["خوشحالم", "غمگینم", "عصبانیم", "خستم", "استرس دارم", "شادم", "ناراحتم", "شگفت زده", "هیجان زده", "کلافه", "happy", "sad", "angry", "tired", "stressed", "excited", "احساس", "حس", "خلق", "خمود", "شادمان", "غمگین", "عصبانی", "خسته", "پراسترس", "ناراحت", "متشکر", "ممنون", "قدردان", "امیدوار", "نومید", "مضطرب", "آرام", "پریشان", "سرحال", "کرخ", "بیحال", "پر انرژی", "بی حوصله"],
            learning: ["یاد بگیر", "آموزش بده", "چطوری", "یادم بده", "چگونه", "طریقه", "روش", "teach", "learn", "how to", "way to", "آموزش", "یادگیری", "تعلیم", "تدریس", "فراگیری", "کسب دانش", "درس", "مدرسه", "دانشگاه", "تحصیل", "مطالعه", "خواندن", "نوشتن", "حفظ کردن", "فهمیدن", "درک کردن", "آموختن", "فرا گرفتن"],
            food: ["غذا", "خوراک", "خورشی", "پلو", "ناهار", "شام", "صبحانه", "میان وعده", "رستوران", "کافه", "food", "restaurant", "cafe", "meal", "خوراکی", "خوردنی", "آشامیدنی", "نوشیدنی", "آب", "چای", "قهوه", "غذاخوری", "پخت", "پز", "دسر", "شیرینی", "خوراک", "سفره", "آشپزی", "دستور پخت", "رسپی", "طعم", "خوشمزه", "بدمزه"],
            sports: ["ورزش", "فوتبال", "والیبال", "بسکتبال", "تنیس", "دو", "شنا", "sport", "football", "basketball", "تمرین", "مسابقه", "لیگ", "قهرمانی", "کاپ", "جام", "تیم", "بازیکن", "مربی", "استادیوم", "ورزشگاه", "تحرک", "فیتنس", "سلامتی", "تناسب اندام", "بدنسازی", "کاراته", "جودو", "کشتی", "مبارزه"]
        };

        const templatesDB = {
            greeting: ["سلام {name}، حالت چطوره؟", "درود بر شما، امروز چطوری؟", "هی {name}، خوبی؟ چه خبر؟", "سلام رفیق، چه خبر؟"],
            personal: ["من هوش مصنوعی BK هستم، دوست دارم بیشتر درباره تو بدونم!", "اسم من BK هست، تو چی؟ دوست داری بیشتر درباره خودت بگی؟", "جالب هست! بیشتر درباره خودت برام بگو."],
            weather: ["امروز هوا {adj}ه، دوست داری بریم بیرون؟", "چه هوای {adj}ای! برنامه خاصی داری؟", "هوا امروز {adj}ه، حس و حالت چطوره؟"],
            daily: ["چه برنامه‌ای برای {time} داری؟", "امروز چیکار کردی؟", "فردا چه کاری داری؟", "برنامه‌ات برای {time} چیه؟"],
            fun: ["می‌خوای یه جوک برات تعریف کنم؟", "یه معما داری میخوای حلش کنی؟", "خنده برای سلامتیه 😄", "میخوای یه سرگرمی انجام بدیم؟"],
            tech: ["امروز در دنیای تکنولوژی چه خبر؟", "میخوای درباره AI حرف بزنیم؟", "ربات‌ها روز به روز هوشمندتر میشن", "میخوای یه نکته تکنولوژی برات بگم؟"],
            emotions: ["میبینم امروز {emo} هستی، میخوای راجع بهش حرف بزنیم؟", "حالت {emo}ه، دوست داری یه چیز خوشحال‌کننده برات تعریف کنم؟", "احساس {emo} داری؟ بیا کمی صحبت کنیم!"],
            learning: ["دوست داری در مورد {topic} چیزی یاد بگیریم؟", "می‌خوای برات درباره {topic} توضیح بدم؟", "یادگیری {topic} میتونه جالب باشه!"],
            food: ["دوست داری درباره غذاها حرف بزنیم؟ غذای مورد علاقت چیه؟", "{topic} خیلی خوشمزست! دوست داری دستور پختش رو بدون؟", "غذا خوردن یکی از لذت‌های زندگیه!"],
            sports: ["ورزش مورد علاقت چیه؟", "دوست داری درباره {topic} صحبت کنیم؟", "ورزش کردن برای سلامتی خیلی مهمه!"]
        };

        const adjectives = ["قشنگ", "خوب", "عالی", "فوقالعاده", "لطیف", "خنک", "گرم", "مرطوب", "شرجی", "تازه", "مطبوع", "خوشایند", "دلپذیر", "مطلوب", "بارانی", "برفی", "ابری", "آفتابی", "طوفانی", "پرباد"];
        const times = ["امروز", "فردا", "این هفته", "این ماه", "آخر هفته", "تعطیلات", "آینده", "هفته آینده", "ماه آینده", "سال آینده"];
        const emotions = ["خوشحال", "غمگین", "عصبی", "خسته", "شاد", "ناراحت", "شگفت‌زده", "هیجان زده", "کلافه", "ممنون", "قدردان", "امیدوار", "نومید", "مضطرب", "آرام"];
        const modes = { normal: "", funny: "😂", romantic: "💖", serious: "🧐", pro: "🤖", sarcastic: "😏", angry: "😡" };

        let userData = { 
            name: "کاربر", 
            mode: "normal", 
            history: [], 
            lastTopics: [], 
            lastResponses: [], 
            interests: [],
            learnedResponses: {},
            context: {} // ذخیره زمینه مکالمه
        };

        // بارگذاری داده‌ها از localStorage اگر وجود داشته باشه
        if (localStorage.getItem('userData')) {
            try {
                const savedData = JSON.parse(localStorage.getItem('userData'));
                userData = { ...userData, ...savedData };
            } catch (e) {
                console.error("خطا در بارگذاری داده‌های ذخیره شده:", e);
            }
        }

        // ====== پردازش زبان طبیعی ساده ======
        function analyzeSentence(message) {
            const words = message.toLowerCase().split(/\s+/);
            const result = {
                categories: [],
                sentiment: 'neutral', // positive, negative, neutral
                keywords: [],
                question: false,
                exclamation: false
            };

            // تشخیص سوال یا تعجب
            if (message.includes('؟') || message.includes('?')) result.question = true;
            if (message.includes('!')) result.exclamation = true;

            // تحلیل احساسات اولیه
            const positiveWords = ['خوشحال', 'شاد', 'خوب', 'عالی', 'فوقالعاده', 'ممنون', 'متشکر', 'دوست دارم', 'عالیه', 'خوش'];
            const negativeWords = ['غمگین', 'ناراحت', 'بد', 'ضعیف', 'مشکل', 'سخت', 'سخته', 'ناراحتم', 'عصبانی', 'خسته', 'استرس'];
            
            let positiveCount = 0;
            let negativeCount = 0;
            
            words.forEach(word => {
                if (positiveWords.includes(word)) positiveCount++;
                if (negativeWords.includes(word)) negativeCount++;
            });
            
            if (positiveCount > negativeCount) result.sentiment = 'positive';
            else if (negativeCount > positiveCount) result.sentiment = 'negative';

            // تشخیص دسته‌ها
            for (const cat in keywordsDB) {
                for (const keyword of keywordsDB[cat]) {
                    if (message.includes(keyword) && !result.categories.includes(cat)) {
                        result.categories.push(cat);
                        result.keywords.push(keyword);
                    }
                }
            }

            return result;
        }

        // ====== تولید پاسخ پیشرفته ======
        function generateResponse(msg) {
            const message = msg.trim();
            const analysis = analyzeSentence(message);
            
            userData.history.push({
                text: message,
                time: new Date().toLocaleTimeString('fa-IR'),
                analysis: analysis
            });
            
            if (userData.history.length > 100) userData.history.shift();

            // بررسی پاسخ‌های یادگرفته شده
            for (const learnedQuestion in userData.learnedResponses) {
                if (message.includes(learnedQuestion)) {
                    return userData.learnedResponses[learnedQuestion];
                }
            }

            // تشخیص نام کاربر
            const nameMatch = message.match(/(اسمم|نامم|من\s+)([^ ]+)(\s+هستم|$)/i);
            if (nameMatch && nameMatch[2]) {
                setUserName(nameMatch[2].trim());
                return `خیلی خوشوقتم ${userData.name} عزیز! چطور می‌تونم کمکت کنم؟`;
            }

            // تشخیص تغییر مود
            const modeMatch = message.match(/(مود|mode)\s+(\w+)/i);
            if (modeMatch && modeMatch[2]) {
                setUserMode(modeMatch[2].toLowerCase());
                return `مود به ${userData.mode} تغییر کرد! ${modes[userData.mode]}`;
            }

            // تشخیص علاقه‌ها
            const interestMatch = message.match(/(علاقه|دوست دارم|هابی|سرگرمی)\s*(به|در|با)?\s*(.+)/i);
            if (interestMatch && interestMatch[3]) {
                addInterest(interestMatch[3].trim());
                return `چه خوب! پس به ${interestMatch[3].trim()} علاقه داری. دوست داری بیشتر در این مورد حرف بزنیم؟`;
            }

            // سیستم یادگیری
            const learnMatch = message.match(/(یاد بگیر|آموزش بده) وقتی میگم (.+?) جواب بده (.+)/i);
            if (learnMatch && learnMatch[2] && learnMatch[3]) {
                userData.learnedResponses[learnMatch[2].trim()] = learnMatch[3].trim();
                localStorage.setItem('userData', JSON.stringify(userData));
                return `چشم! یاد گرفتم وقتی میگی "${learnMatch[2].trim()}" جواب بدم "${learnMatch[3].trim()}"`;
            }

            // معرفی ربات
            const selfKeywords = ["تو چی هستی", "تو چه مدلی", "هوش مصنوعی تو", "چی هستی", "مدل هوش مصنوعی", "who are you", "what are you"];
            if (selfKeywords.some(k => message.includes(k))) {
                return `من هوش مصنوعی BK هستم 🤖، یک ربات حرفه‌ای برای چت و کمک! می‌تونم در مورد ${userData.interests.length > 0 ? userData.interests.join('، ') : "موضوعات مختلف"} با تو صحبت کنم.`;
            }

            // پاسخ به بی‌احترامی
            const rudeRegex = /(بی ادب|حرامزاده|لعنتی|سکس|جنسی|\+18|fuck|shit|sex|idiot|stupid|کوس|کوس کش|مادر خراب|کادر جنده|جنده|کونی|گی|مادرت رو گایدم|ننت رو گایدم|ننه جنده|ننه خراب)/i;
            if (rudeRegex.test(message)) {
                return "لطفا ادب رو رعایت کنید. بیایید محترمانه گفتگو کنیم.";
            }

            // اگر هیچ دسته‌ای تشخیص داده نشد
            if (analysis.categories.length === 0) {
                // استفاده از زمینه مکالمه قبلی
                if (userData.context.lastCategory) {
                    return `در مورد ${userData.context.lastCategory} صحبت می‌کردیم. دوست داری بیشتر در این مورد بگم؟ یا موضوع دیگری دوست داری؟`;
                }
                
                // پاسخ بر اساس احساس تشخیص داده شده
                if (analysis.sentiment === 'positive') {
                    return "چه عالی! دوست داری بیشتر در این مورد صحبت کنیم؟";
                } else if (analysis.sentiment === 'negative') {
                    return "به نظر می‌رسه کمی ناراحت هستی. دوست داری در این مورد صحبت کنیم؟";
                }
                
                return randomChoice([
                    "جالب است! بیشتر برام تعریف کن.",
                    "چه خوب! دوست داری بیشتر صحبت کنیم؟",
                    "منظورت رو کامل متوجه نشدم، میشه بیشتر توضیح بدی؟",
                    `دوست داری یه موضوع جدید شروع کنیم؟ شاید در مورد ${userData.interests.length > 0 ? randomChoice(userData.interests) : "هوش مصنوعی"} صحبت کنیم؟`
                ]);
            }

            // تولید پاسخ بر اساس دسته‌های تشخیص داده شده
            const selectedCategories = randomItems(analysis.categories, Math.min(analysis.categories.length, 2));
            let responses = [];
            
            selectedCategories.forEach(cat => {
                let tpl = randomChoice(templatesDB[cat]);
                
                // جایگزینی متغیرها
                tpl = tpl.replace(/{name}/g, userData.name)
                         .replace(/{adj}/g, randomChoice(adjectives))
                         .replace(/{time}/g, randomChoice(times))
                         .replace(/{emo}/g, randomChoice(emotions))
                         .replace(/{topic}/g, analysis.keywords[0] || cat);
                
                responses.push(tpl);
            });
            
            let response = responses.join(" ");

            // اضافه کردن علاقه‌ها به پاسخ اگر مرتبط
            if (userData.interests.length > 0 && Math.random() > 0.5) {
                const interest = randomChoice(userData.interests);
                if (selectedCategories.some(cat => ['tech', 'sports', 'food'].includes(cat))) {
                    response += ` راستی، دیدم به ${interest} علاقه داری، می‌خوای بیشتر حرف بزنیم؟`;
                }
            }

            // افزودن مود
            if (modes[userData.mode]) response += " " + modes[userData.mode];

            // ذخیره زمینه مکالمه
            userData.context.lastCategory = selectedCategories[0];
            userData.lastTopics = [...selectedCategories];
            userData.lastResponses.push(response);
            if (userData.lastResponses.length > 50) userData.lastResponses.shift();

            // ذخیره در localStorage
            localStorage.setItem('userData', JSON.stringify(userData));

            return response;
        }

        // ====== کمکی ======
        function randomChoice(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        
        function randomItems(arr, n) {
            const shuffled = [...arr];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled.slice(0, n);
        }
        
        function setUserName(name) { 
            userData.name = name || "کاربر"; 
            localStorage.setItem('userData', JSON.stringify(userData));
        }
        
        function setUserMode(mode) { 
            if (modes[mode]) {
                userData.mode = mode; 
                localStorage.setItem('userData', JSON.stringify(userData));
            }
        }
        
        function addInterest(interest) { 
            if (!userData.interests.includes(interest)) {
                userData.interests.push(interest); 
                localStorage.setItem('userData', JSON.stringify(userData));
            }
        }

        // ====== رابط کاربری ======
        const inputField = document.getElementById("userInput");
        const sendBtn = document.getElementById("sendBtn");
        const chatContainer = document.getElementById("chatContainer");
        const typingIndicator = document.getElementById("typingIndicator");

        function addMessage(msg, type) {
            const el = document.createElement("div");
            el.classList.add("message", type === "user" ? "user-message" : "bot-message");
            
            const messageText = document.createElement("div");
            messageText.textContent = msg;
            el.appendChild(messageText);
            
            const messageTime = document.createElement("div");
            messageTime.classList.add("message-time");
            messageTime.textContent = new Date().toLocaleTimeString('fa-IR');
            el.appendChild(messageTime);
            
            chatContainer.appendChild(el);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTypingIndicator() {
            typingIndicator.style.display = 'block';
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }

        function sendMessage() {
            const msg = inputField.value.trim();
            if (msg === "") return;
            
            addMessage(msg, "user");
            inputField.value = "";
            
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                addMessage(generateResponse(msg), "bot");
            }, 1000 + Math.random() * 1000);
        }

        sendBtn.addEventListener("click", sendMessage);
        inputField.addEventListener("keypress", e => { 
            if (e.key === "Enter") sendMessage(); 
        });

        // بارگذاری تاریخچه گفتگو
        window.addEventListener('load', () => {
            if (userData.history.length > 0) {
                userData.history.slice(-5).forEach(item => {
                    addMessage(item.text, "user");
                });
            }
        });
    </script>
</body>
</html>
