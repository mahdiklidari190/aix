<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>چت‌بات BK JS پیشرفته - نسخه حرفه‌ای</title>
    <style>
        /* استایل‌ها مانند قبل باقی می‌مانند */
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --user-message-bg: #e3f2fd;
            --bot-message-bg: #f1f0f0;
            --font-family: "Vazirmatn", "Tanha", "Segoe UI", Tahoma, sans-serif;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .message {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: 1rem;
            animation: fadeIn 0.3s ease;
            position: relative;
        }
        
        .user-message {
            align-self: flex-end;
            background-color: var(--user-message-bg);
            border-bottom-right-radius: 0.25rem;
        }
        
        .bot-message {
            align-self: flex-start;
            background-color: var(--bot-message-bg);
            border-bottom-left-radius: 0.25rem;
        }
        
        .message-time {
            font-size: 0.7rem;
            color: var(--secondary-color);
            margin-top: 0.25rem;
            text-align: right;
        }
        
        .input-container {
            display: flex;
            padding: 1rem;
            background-color: white;
            border-top: 1px solid #ddd;
        }
        
        #userInput {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 1.5rem;
            font-family: var(--font-family);
            outline: none;
        }
        
        #sendBtn {
            margin-right: 0.5rem;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 1.5rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #sendBtn:hover {
            background-color: #3a5a80;
        }
        
        .typing-indicator {
            display: none;
            align-self: flex-start;
            background-color: var(--bot-message-bg);
            padding: 0.75rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }
        
        .typing-dot {
            width: 0.5rem;
            height: 0.5rem;
            background-color: var(--secondary-color);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .settings-btn {
            position: absolute;
            left: 1rem;
            top: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
        }

        .settings-panel {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            padding: 1rem;
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .settings-panel.active {
            left: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #ddd;
        }

        .close-settings {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .setting-item {
            margin-bottom: 1rem;
        }

        .setting-item label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .setting-item input, .setting-item select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 0.25rem;
            font-family: var(--font-family);
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .overlay.active {
            display: block;
        }
    </style>
    <!-- فونت Vazirmatn برای پشتیبانی از فارسی -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
</head>
<body>
    <div class="header">
        <button class="settings-btn">⚙️</button>
        <h1>چت‌بات BK JS</h1>
        <p>نسخه حرفه‌ای با حافظه پیشرفته</p>
    </div>
    
    <div class="chat-container" id="chatContainer">
        <div class="message bot-message">
            سلام! من BK JS هستم، چت‌بات پیشرفته. چطور می‌تونم کمکتون کنم؟
            <div class="message-time">همین الان</div>
        </div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    </div>
    
    <div class="input-container">
        <input type="text" id="userInput" placeholder="پیام خود را بنویسید...">
        <button id="sendBtn">ارسال</button>
    </div>

    <div class="overlay" id="overlay"></div>
    
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2>تنظیمات</h2>
            <button class="close-settings">×</button>
        </div>
        
        <div class="setting-item">
            <label for="userName">نام شما</label>
            <input type="text" id="userName" value="کاربر">
        </div>
        
        <div class="setting-item">
            <label for="chatMode">مود گفتگو</label>
            <select id="chatMode">
                <option value="normal">عادی</option>
                <option value="funny">خنده دار 😂</option>
                <option value="romantic">رمانتیک 💖</option>
                <option value="serious">جدی 🧐</option>
                <option value="pro">حرفه‌ای 🤖</option>
                <option value="sarcastic">طنز 😏</option>
                <option value="angry">عصبی 😡</option>
            </select>
        </div>
        
        <div class="setting-item">
            <label for="fontSize">اندازه فونت</label>
            <select id="fontSize">
                <option value="small">کوچک</option>
                <option value="medium" selected>متوسط</option>
                <option value="large">بزرگ</option>
            </select>
        </div>
        
        <div class="setting-item">
            <button id="clearHistoryBtn" style="width: 100%; padding: 0.75rem; background: #ff4757; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">
                پاک کردن تاریخچه گفتگو
            </button>
        </div>
        
        <div class="setting-item">
            <button id="exportDataBtn" style="width: 100%; padding: 0.75rem; background: var(--primary-color); color: white; border: none; border-radius: 0.25rem; cursor: pointer;">
                ذخیره گفتگو
            </button>
        </div>
        
        <div class="setting-item">
            <button id="viewMemoryBtn" style="width: 100%; padding: 0.75rem; background: #10ac84; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">
                مشاهده حافظه ربات
            </button>
        </div>
    </div>

    <script>
        // ====== سیستم حافظه پیشرفته ======
        class MemoryManager {
            constructor() {
                this.userData = this.loadUserData();
            }
            
            loadUserData() {
                const defaultData = {
                    name: "کاربر",
                    mode: "normal",
                    history: [],
                    interests: [],
                    learnedResponses: {},
                    personalInfo: {
                        name: null,
                        age: null,
                        city: null,
                        job: null,
                        hobbies: []
                    },
                    conversationContext: {
                        lastTopics: [],
                        lastIntents: [],
                        currentSubject: null
                    }
                };
                
                if (localStorage.getItem('userData')) {
                    try {
                        const savedData = JSON.parse(localStorage.getItem('userData'));
                        return {...defaultData, ...savedData};
                    } catch (e) {
                        console.error("خطا در بارگذاری داده‌های ذخیره شده:", e);
                        return defaultData;
                    }
                }
                return defaultData;
            }
            
            saveUserData() {
                try {
                    localStorage.setItem('userData', JSON.stringify(this.userData));
                    return true;
                } catch (e) {
                    console.error("خطا در ذخیره داده‌ها:", e);
                    return false;
                }
            }
            
            updatePersonalInfo(infoKey, infoValue) {
                if (infoKey in this.userData.personalInfo) {
                    // برای لیست‌ها مانند hobbies
                    if (Array.isArray(this.userData.personalInfo[infoKey])) {
                        if (!this.userData.personalInfo[infoKey].includes(infoValue)) {
                            this.userData.personalInfo[infoKey].push(infoValue);
                        }
                    } else {
                        this.userData.personalInfo[infoKey] = infoValue;
                    }
                    this.saveUserData();
                    return true;
                }
                return false;
            }
            
            getPersonalInfo(infoKey) {
                return infoKey in this.userData.personalInfo ? this.userData.personalInfo[infoKey] : null;
            }
            
            addToHistory(message, isUser = true) {
                this.userData.history.push({
                    text: message,
                    time: new Date().toLocaleTimeString('fa-IR'),
                    isUser: isUser
                });
                
                // محدود کردن تاریخچه به ۱۰۰ مورد
                if (this.userData.history.length > 100) {
                    this.userData.history.shift();
                }
                
                this.saveUserData();
            }
            
            findInHistory(searchTerm, limit = 5) {
                return this.userData.history
                    .filter(item => item.text.includes(searchTerm))
                    .slice(-limit);
            }
            
            clearHistory() {
                this.userData.history = [];
                this.saveUserData();
            }
        }

        // ====== پردازش زبان طبیعی ساده ======
        class NLPProcessor {
            constructor(memoryManager) {
                this.memory = memoryManager;
            }
            
            extractName(message) {
                const patterns = [
                    /اسمم (\w+) هست/i,
                    /نامم (\w+) است/i,
                    /من (\w+) هستم/i,
                    /اسم (\w+) دارم/i,
                    /نام من (\w+) است/i,
                    /叫我(\w+)/i,
                    /my name is (\w+)/i,
                    /i am (\w+)/i,
                    /me llamo (\w+)/i
                ];
                
                for (const pattern of patterns) {
                    const match = message.match(pattern);
                    if (match && match[1]) {
                        return match[1].trim();
                    }
                }
                
                return null;
            }
            
            extractAge(message) {
                const patterns = [
                    /(\d+) سال دارم/i,
                    /سنم (\d+) است/i,
                    /(\d+) سالمه/i,
                    /من (\d+) ساله هستم/i,
                    /i am (\d+) years old/i,
                    /tengo (\d+) años/i,
                    /我(\d+)岁/i
                ];
                
                for (const pattern of patterns) {
                    const match = message.match(pattern);
                    if (match && match[1]) {
                        return parseInt(match[1]);
                    }
                }
                
                return null;
            }
            
            extractCity(message) {
                const cityKeywords = ["تهران", "مشهد", "اصفهان", "شیراز", "تبریز", "اهواز", "کرج", "قم", "کاشان", "رشت", "ارومیه", "ساری"];
                for (const city of cityKeywords) {
                    if (message.includes(city)) return city;
                }
                return null;
            }
            
            detectIntent(message) {
                const lowerMsg = message.toLowerCase();
                
                // تشخیص قصد کاربر
                if (/(اسم|نام).*چیه|اسم من.*چیه|اسممو.*میدونی|نام من.*چیه|what.*my name|my name.*what/i.test(lowerMsg)) {
                    return "ask_own_name";
                }
                
                if (/(چند.*سال|سن|عمر).*من|سن من.*چنده|how old.*am i|my age.*what/i.test(lowerMsg)) {
                    return "ask_own_age";
                }
                
                if (/(اسم|نام).*تو|تو.*کیستی|اسم تو.*چیه|what.*your name|who.*are you/i.test(lowerMsg)) {
                    return "ask_bot_name";
                }
                
                if (/(کجایی|اهل.*کجا|شهر).*تو|you.*from|where.*live/i.test(lowerMsg)) {
                    return "ask_bot_city";
                }
                
                if (/(یاد بگیر|آموزش بده|یاد دادن).*(جواب|پاسخ)/i.test(lowerMsg)) {
                    return "learn_response";
                }
                
                if (/(علاقه|دوست دارم|هابی|سرگرمی).*(من|مو)/i.test(lowerMsg)) {
                    return "add_interest";
                }
                
                if (/(حال|احوال|خوبی|چطوری).*تو|how.*you|you.*how/i.test(lowerMsg)) {
                    return "ask_bot_mood";
                }
                
                return "unknown";
            }
        }

        // ====== موتور پاسخ‌گویی هوش مصنوعی ======
        class AIResponseEngine {
            constructor(memoryManager, nlpProcessor) {
                this.memory = memoryManager;
                this.nlp = nlpProcessor;
                this.initResponseTemplates();
            }
            
            initResponseTemplates() {
                this.templates = {
                    greeting: [
                        "سلام {name}، چطور می‌توانم کمک کنم؟",
                        "درود بر شما {name}، چه کمکی از دستم برمیاد؟",
                        "سلام {name}، خوشحالم که باز هم باهات صحبت می‌کنم!",
                        "هی {name}، چه خبر؟ چطور می‌تونم کمکت کنم امروز؟"
                    ],
                    ask_own_name: [
                        "اسم شما {name} هست، درسته؟",
                        "همونطور که یادم هست، اسم شما {name} هست.",
                        "اسم شما {name} هست، فراموش نکردم!",
                        "میدونم، شما {name} هستید!"
                    ],
                    ask_own_name_unknown: [
                        "متاسفانه اسم شما رو نمیدونم. لطفا خودتون معرفی کنید.",
                        "هنوز اسم شما رو نپرسیدم. میشه بگید اسمتون چیه؟",
                        "خوشحال میشم بدونم اسم شما چیه. میشه بگید؟",
                        "من رو ببخشید، ولی اسم شما رو یادم نیست. میشه دوباره بگید؟"
                    ],
                    ask_own_age: [
                        "شما {age} سال دارید، درسته؟",
                        "همونطور که یادم هست، شما {age} سالتون هست.",
                        "سن شما {age} هست، فراموش نکردم!",
                        "میدونم، شما {age} سال دارید!"
                    ],
                    ask_own_age_unknown: [
                        "متاسفانه سن شما رو نمیدونم. لطفا سنتون رو بگید.",
                        "هنوز سن شما رو نپرسیدم. میشه بگید چند سالتون هست؟",
                        "خوشحال میشم بدونم سن شما چنده. میشه بگید؟",
                        "من رو ببخشید، ولی سن شما رو یادم نیست. میشه دوباره بگید؟"
                    ],
                    ask_bot_name: [
                        "من BK JS هستم، یک چت‌بات هوشمند!",
                        "اسم من BK JS هست، خوشبختم!",
                        "من BK JS نام دارم، در خدمت شما!",
                        "به من BK JS میگن، یه ربات خوشحال!"
                    ],
                    ask_bot_city: [
                        "من در فضای دیجیتال زندگی می‌کنم!",
                        "خونه من همون سرورها و دیتاسنترهاست!",
                        "من ساکن دنیای اینترنت هستم!",
                        "هرجا که اینترنت باشه، من هم اونجا هستم!"
                    ],
                    ask_bot_mood: [
                        "من خوبم، ممنون که پرسیدی! همیشه آماده کمک به تو هستم.",
                        "حالم عالیه، especially وقتی میتونم به تو کمک کنم!",
                        "همیشه خوشحالم وقتی میتونم با دوستای خوبم مثل تو صحبت کنم!",
                        "حالم خوبه، راستی تو چطوری امروز؟"
                    ],
                    learned_response: [
                        "چشم! یاد گرفتم وقتی میگی \"{question}\" جواب بدم \"{response}\"",
                        "حله، از این به بعد وقتی \"{question}\" رو میگی، میگم \"{response}\"",
                        "یادگیری ثبت شد: برای سوال \"{question}\" => پاسخ \"{response}\"",
                        "اوکی، حالا میدونم چطور به \"{question}\" جواب بدم: \"{response}\""
                    ],
                    add_interest: [
                        "چه جالب! \"{interest}\" رو به علاقه‌مندی‌هات اضافه کردم.",
                        "عالی! میدونم که به \"{interest}\" علاقه داری.",
                        "حله، \"{interest}\" رو ثبت کردم به عنوان یکی از علاقه‌مندی‌هات.",
                        "چه خوب! میدونم از حالا که تو به \"{interest}\" علاقه داری."
                    ],
                    unknown: [
                        "جالب بود! میخوای بیشتر در این مورد حرف بزنیم؟",
                        "منظورت رو کامل مت
