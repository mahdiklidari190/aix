<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ BK AI Pro</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --user-message-bg: #e3f2fd;
            --bot-message-bg: #f1f0f0;
            --math-message-bg: #e8f5e9;
            --search-message-bg: #fff3cd;
            --font-family: "Vazirmatn", "Tanha", "Segoe UI", Tahoma, sans-serif;
            --text-color: #333;
            --border-color: #ddd;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .dark-mode {
            --primary-color: #5a7fb5;
            --secondary-color: #8b9cb0;
            --background-color: #1a1a1a;
            --user-message-bg: #2a4b7c;
            --bot-message-bg: #3a3a3a;
            --math-message-bg: #2d4a2d;
            --search-message-bg: #5c4b15;
            --text-color: #f0f0f0;
            --border-color: #444;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
        }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .message {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1.2rem;
            animation: fadeIn 0.3s ease;
            position: relative;
            border: 1px solid var(--border-color);
            line-height: 1.6;
            box-shadow: var(--shadow);
        }
        .user-message { align-self: flex-end; background-color: var(--user-message-bg); border-bottom-right-radius: 0.4rem; }
        .bot-message { align-self: flex-start; background-color: var(--bot-message-bg); border-bottom-left-radius: 0.4rem; }
        .math-message { align-self: flex-start; background-color: var(--math-message-bg); border-bottom-left-radius: 0.4rem; border-left: 4px solid #4caf50; }
        .search-message { align-self: flex-start; background-color: var(--search-message-bg); border-bottom-left-radius: 0.4rem; border-left: 4px solid #ffc107; }
        .message-time { font-size: 0.7rem; color: var(--secondary-color); margin-top: 0.5rem; text-align: right; }
        .input-container {
            display: flex;
            padding: 1rem;
            background-color: var(--bot-message-bg);
            border-top: 1px solid var(--border-color);
            gap: 0.5rem;
        }
        #userInput {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
            font-family: var(--font-family);
            outline: none;
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s;
        }
        #userInput:focus { border-color: var(--primary-color); }
        #sendBtn {
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #sendBtn:hover { background-color: #3a5a80; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        #sendBtn:active { transform: translateY(0); }
        .typing-indicator {
            display: none;
            align-self: flex-start;
            background-color: var(--bot-message-bg);
            padding: 0.75rem 1rem;
            border-radius: 1.2rem;
            margin-bottom: 0.5rem;
            box-shadow: var(--shadow);
        }
        .typing-dots { display: flex; gap: 0.35rem; }
        .typing-dot {
            width: 0.6rem; height: 0.6rem; background-color: var(--secondary-color);
            border-radius: 50%; animation: typingAnimation 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes typingAnimation { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }
        .settings-btn {
            position: absolute; left: 1rem; top: 1rem; background: none; border: none;
            font-size: 1.5rem; cursor: pointer; color: white; transition: transform 0.3s;
            padding: 0.5rem; border-radius: 50%;
        }
        .settings-btn:hover { transform: rotate(45deg); background-color: rgba(255,255,255,0.1); }
        .theme-toggle {
            position: absolute; right: 1rem; top: 1rem; background: none; border: none;
            font-size: 1.5rem; cursor: pointer; color: white; transition: transform 0.3s;
            padding: 0.5rem; border-radius: 50%;
        }
        .theme-toggle:hover { transform: scale(1.1); background-color: rgba(255,255,255,0.1); }
        .math-expression { font-family: monospace; background-color: rgba(0,0,0,0.05); padding: 0.2rem 0.5rem; border-radius: 0.3rem; direction: ltr; display: inline-block; margin: 0 0.2rem; font-weight: bold; }
        .math-result { font-weight: bold; color: #2e7d32; direction: ltr; display: inline-block; }
        .dark-mode .math-expression { background-color: rgba(255,255,255,0.1); }
        .dark-mode .math-result { color: #81c784; }
        .search-results { margin-top: 0.75rem; padding: 0.75rem; background-color: rgba(0,0,0,0.05); border-radius: 0.8rem; font-size: 0.9rem; }
        .dark-mode .search-results { background-color: rgba(255,255,255,0.05); }
        .search-result-item { margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px dashed var(--border-color); }
        .search-result-item:last-child { border-bottom: none; margin-bottom: 0; }
        .search-result-title { font-weight: bold; color: var(--primary-color); margin-bottom: 0.25rem; }
        .search-result-link { color: var(--secondary-color); font-size: 0.8rem; text-decoration: none; display: block; margin-bottom: 0.25rem; }
        .search-result-link:hover { text-decoration: underline; }
        .search-result-snippet { color: var(--text-color); font-size: 0.9rem; }
        .settings-panel {
            position: fixed; top: 0; left: -320px; width: 320px; height: 100%;
            background: var(--bot-message-bg); box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            padding: 1.5rem; transition: left 0.3s ease; z-index: 1000; overflow-y: auto;
        }
        .settings-panel.active { left: 0; }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .settings-title { font-size: 1.5rem; font-weight: bold; color: var(--text-color); }
        .close-settings { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-color); transition: transform 0.3s; }
        .close-settings:hover { transform: scale(1.1); }
        .setting-item { margin-bottom: 1.25rem; }
        .setting-item label { display: block; margin-bottom: 0.5rem; font-weight: bold; color: var(--text-color); }
        .setting-item input, .setting-item select {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border-color);
            border-radius: 0.5rem; font-family: var(--font-family);
            background-color: var(--background-color); color: var(--text-color); font-size: 1rem;
        }
        .setting-item select { cursor: pointer; }
        .overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 999;
        }
        .overlay.active { display: block; }
        .btn {
            padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem;
            cursor: pointer; font-weight: bold; transition: all 0.3s; font-family: var(--font-family);
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-danger { background-color: #ff4757; color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn:active { transform: translateY(0); }
        .suggestion-chips {
            display: flex; gap: 0.5rem; padding: 0.5rem 1rem;
            background-color: var(--bot-message-bg); border-top: 1px solid var(--border-color); overflow-x: auto;
        }
        .suggestion-chip {
            padding: 0.5rem 1rem; background-color: var(--background-color);
            border: 1px solid var(--border-color); border-radius: 1.5rem; cursor: pointer;
            white-space: nowrap; font-size: 0.9rem; transition: all 0.3s;
        }
        .suggestion-chip:hover { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
        @media (max-width: 768px) {
            .message { max-width: 90%; }
            .settings-panel { width: 85%; left: -85%; }
            .header h1 { font-size: 1.3rem; }
            .header p { font-size: 0.9rem; }
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
    <!-- PWA manifest and icons for modern UX -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4a6fa5">
</head>
<body>
    <div class="header">
        <button class="settings-btn" id="settingsBtn" aria-label="ØªÙ†Ø¸ÛŒÙ…Ø§Øª">âš™ï¸</button>
        <button class="theme-toggle" id="themeToggle" aria-label="ØªØºÛŒÛŒØ± ØªÙ…">ğŸŒ™</button>
        <h1>Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ BK AI Pro</h1>
        <p>Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø§ Ø¯Ø±Ú© Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø²Ø¨Ø§Ù† Ùˆ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¬Ø³ØªØ¬Ùˆ</p>
    </div>
    <div class="chat-container" id="chatContainer">
        <div class="message bot-message">
            Ø³Ù„Ø§Ù…! Ù…Ù† BK AI Pro Ù‡Ø³ØªÙ…ØŒ ÛŒÚ© Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¯Ø±Ú© Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø²Ø¨Ø§Ù† Ùˆ Ø¬Ø³ØªØ¬Ùˆ. Ú†Ú¯ÙˆÙ†Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ú©Ù†Ù…ØŸ
            <div class="message-time">Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†</div>
        </div>
    </div>
    <div class="suggestion-chips" id="suggestionChips">
        <div class="suggestion-chip" data-query="Ø³Ù„Ø§Ù…ØŒ Ø­Ø§Ù„Øª Ú†Ø·ÙˆØ±Ù‡ØŸ">Ø³Ù„Ø§Ù…ØŒ Ø­Ø§Ù„Øª Ú†Ø·ÙˆØ±Ù‡ØŸ</div>
        <div class="suggestion-chip" data-query="Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù† Û±Û²Ûµ Ø¶Ø±Ø¨Ø¯Ø± Û´Û³">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù† Û±Û²Ûµ Ã— Û´Û³</div>
        <div class="suggestion-chip" data-query="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ">Ø¬Ø³ØªØ¬Ùˆ: Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</div>
        <div class="suggestion-chip" data-query="Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³ÛŒ ÛŒØ§Ø¯ Ø¨Ú¯ÛŒØ±Ù…ØŸ">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³ÛŒ ÛŒØ§Ø¯ Ø¨Ú¯ÛŒØ±Ù…</div>
    </div>
    <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    </div>
    <div class="input-container">
        <input type="text" id="userInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ ÛŒØ§ ÛŒÚ© Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ§Ø¶ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." autocomplete="off">
        <button id="sendBtn">Ø§Ø±Ø³Ø§Ù„</button>
    </div>
    <div class="overlay" id="overlay"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2 class="settings-title">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
            <button class="close-settings" id="closeSettings">Ã—</button>
        </div>
        <div class="setting-item">
            <label for="userName">Ù†Ø§Ù… Ø´Ù…Ø§</label>
            <input type="text" id="userName" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        </div>
        <div class="setting-item">
            <label for="chatMode">Ù…ÙˆØ¯ Ú¯ÙØªÚ¯Ùˆ</label>
            <select id="chatMode">
                <option value="normal">Ø¹Ø§Ø¯ÛŒ</option>
                <option value="friendly">Ø¯ÙˆØ³ØªØ§Ù†Ù‡ ğŸ¤</option>
                <option value="professional">Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ğŸ’¼</option>
                <option value="funny">Ø®Ù†Ø¯Ù‡ Ø¯Ø§Ø± ğŸ˜‚</option>
            </select>
        </div>
        <div class="setting-item">
            <label for="responseLength">Ø·ÙˆÙ„ Ù¾Ø§Ø³Ø®</label>
            <select id="responseLength">
                <option value="short">Ú©ÙˆØªØ§Ù‡</option>
                <option value="medium" selected>Ù…ØªÙˆØ³Ø·</option>
                <option value="long">Ø·ÙˆÙ„Ø§Ù†ÛŒ</option>
            </select>
        </div>
        <div class="setting-item">
            <label for="searchEngine">Ù…ÙˆØªÙˆØ± Ø¬Ø³ØªØ¬Ùˆ</label>
            <select id="searchEngine">
                <option value="duckduckgo">DuckDuckGo</option>
                <option value="wikipedia">ÙˆÛŒÚ©ÛŒâ€ŒÙ¾Ø¯ÛŒØ§</option>
                <option value="both">Ù‡Ø± Ø¯Ùˆ</option>
            </select>
        </div>
        <div class="setting-item">
            <button id="clearHistoryBtn" class="btn btn-danger" style="width: 100%">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú¯ÙØªÚ¯Ùˆ</button>
        </div>
        <div class="setting-item">
            <button id="resetSettingsBtn" class="btn" style="width: 100%; background-color: var(--secondary-color); color: white">Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
        </div>
    </div>
    <!-- Unified AI, Modern JS (ES2023+) -->
    <script type="module">
        // Helper functions
        const $ = s => document.querySelector(s);
        const $$ = s => document.querySelectorAll(s);
        const sleep = ms => new Promise(res => setTimeout(res, ms));

        // Modern Settings Store
        class Settings {
            static defaults = {
                userName: "",
                chatMode: "normal",
                responseLength: "medium",
                searchEngine: "duckduckgo",
                darkMode: false
            };
            static get(key) {
                const item = localStorage.getItem('BKAI_' + key);
                return item !== null ? JSON.parse(item) : Settings.defaults[key];
            }
            static set(key, value) {
                localStorage.setItem('BKAI_' + key, JSON.stringify(value));
            }
            static reset() {
                Object.keys(Settings.defaults).forEach(k => {
                    Settings.set(k, Settings.defaults[k]);
                });
            }
        }

        // Unified AI Core: NLP + Search + Math + Context
        class UnifiedAI {
            constructor() {
                this.patterns = this.createPatterns();
                this.context = {
                    userName: Settings.get("userName"),
                    chatMode: Settings.get("chatMode"),
                    responseLength: Settings.get("responseLength"),
                    searchEngine: Settings.get("searchEngine"),
                    history: [],
                    darkMode: Settings.get("darkMode")
                };
            }
            createPatterns() {
                return [
                    // greeting
                    { pattern: /(Ø³Ù„Ø§Ù…|Ø¯Ø±ÙˆØ¯|ØµØ¨Ø­ Ø¨Ø®ÛŒØ±|Ø¹ØµØ± Ø¨Ø®ÛŒØ±|Ø´Ø¨ Ø¨Ø®ÛŒØ±|hello|hi|hey)/i, type: "greeting" },
                    // thanks
                    { pattern: /(Ù…Ù…Ù†ÙˆÙ†|ØªØ´Ú©Ø±|Ù…Ø±Ø³ÛŒ|thanks|thank you)/i, type: "thanks" },
                    // about bot
                    { pattern: /(ØªÙˆ Ú©ÛŒØ³ØªÛŒ|Ø§Ø³Ù… ØªÙˆ Ú†ÛŒÙ‡|ØªÙˆ Ú†ÛŒ Ù‡Ø³ØªÛŒ|who are you|what are you)/i, type: "about_bot" },
                    // time
                    { pattern: /(Ø³Ø§Ø¹Øª Ú†Ù†Ø¯Ù‡|ÙˆÙ‚Øª Ú†Ù†Ø¯Ù‡|what time|what is the time)/i, type: "time" },
                    // date
                    { pattern: /(Ø§Ù…Ø±ÙˆØ² Ú†Ù†Ø¯Ù…Ù‡|ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ²|what date|what is the date)/i, type: "date" },
                    // goodbye
                    { pattern: /(Ø®Ø¯Ø§Ø­Ø§ÙØ¸|Ø¨Ø§ÛŒ|bye|goodbye|see you)/i, type: "goodbye" },
                    // emotion
                    { pattern: /(Ø®ÙˆØ´Ø­Ø§Ù„Ù…|ØºÙ…Ú¯ÛŒÙ†Ù…|Ø¹ØµØ¨Ø§Ù†ÛŒÙ…|Ø®Ø³ØªÙ…|Ø§Ø³ØªØ±Ø³ Ø¯Ø§Ø±Ù…|Ù†Ø§Ø±Ø§Ø­ØªÙ…|Ù†Ú¯Ø±Ø§Ù†Ù…|happy|sad|angry|tired)/i, type: "emotion" },
                    // math
                    { pattern: /(\d+\s*[\+\-\Ã—\Ã·\*\/().]\s*)+\d+|(Ù…Ø­Ø§Ø³Ø¨Ù‡|Ø±ÛŒØ§Ø¶ÛŒ|calculate|Ú†Ù‚Ø¯Ø± Ù…ÛŒØ´Ù‡)/i, type: "math" },
                    // search
                    { pattern: /(Ø¬Ø³ØªØ¬Ùˆ|Ø³Ø±Ú†|search|Ø¨Ú¯Ø±Ø¯|Ù¾ÛŒØ¯Ø§ Ú©Ù†|Ø¯Ø±Ø¨Ø§Ø±Ù‡|Ø¯Ø± Ù…ÙˆØ±Ø¯|search for|about )/i, type: "search" }
                ];
            }
            async process(message) {
                this.context.history.push({ type: 'user', message, time: new Date() });
                let msgType = "default";
                for (const {pattern, type} of this.patterns) {
                    if (pattern.test(message)) { msgType = type; break; }
                }
                let result;
                switch (msgType) {
                    case "math":
                        result = this.handleMath(message);
                        break;
                    case "search":
                        result = await this.handleSearch(message);
                        break;
                    default:
                        result = this.handleGeneric(msgType, message);
                }
                this.context.history.push({ type: 'bot', message: result.response, time: new Date() });
                return result;
            }
            handleGeneric(type, message) {
                const responses = {
                    greeting: [
                        "Ø³Ù„Ø§Ù…! Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú© Ú©Ù†Ù…ØŸ",
                        "Ø¯Ø±ÙˆØ¯ Ø¨Ø± Ø´Ù…Ø§! Ø­Ø§Ù„ØªÙˆÙ† Ú†Ø·ÙˆØ±Ù‡ØŸ",
                        "Ø³Ù„Ø§Ù…! Ø®ÙˆØ´Ø­Ø§Ù„Ù… Ú©Ù‡ Ø¨Ø§Ù‡Ø§Øª ØµØ­Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†Ù…."
                    ],
                    thanks: [
                        "Ø®ÙˆØ§Ù‡Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ù…!",
                        "Ù‚Ø§Ø¨Ù„ÛŒ Ù†Ø¯Ø§Ø´Øª!",
                        "Ø®ÙˆØ´Ø­Ø§Ù„Ù… Ú©Ù‡ ØªÙˆÙ†Ø³ØªÙ… Ú©Ù…Ú© Ú©Ù†Ù…!"
                    ],
                    about_bot: [
                        "Ù…Ù† BK AI Pro Ù‡Ø³ØªÙ…ØŒ ÛŒÚ© Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ù…Ú© Ø¨Ù‡ Ø´Ù…Ø§.",
                        "Ø§Ø³Ù… Ù…Ù† BK AI Pro Ù‡Ø³ØªØŒ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯."
                    ],
                    time: [
                        `Ø§Ù„Ø§Ù† Ø³Ø§Ø¹Øª ${new Date().toLocaleTimeString('fa-IR')}.`
                    ],
                    date: [
                        `Ø§Ù…Ø±ÙˆØ² ${new Date().toLocaleDateString('fa-IR')} Ù‡Ø³Øª.`
                    ],
                    goodbye: [
                        "Ø®Ø¯Ø§Ø­Ø§ÙØ¸! Ø§Ù…ÛŒØ¯ÙˆØ§Ø±Ù… Ø¨Ø§Ø²Ù… Ø¨Ø¨ÛŒÙ†Ù…Øª.",
                        "Ø¨Ø§ÛŒ! Ø±ÙˆØ² Ø®ÙˆØ¨ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒ."
                    ],
                    emotion: [
                        "Ù…ØªÙˆØ¬Ù‡ Ø§Ø­Ø³Ø§Ø³Øª Ù…ÛŒØ´Ù…. Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒ Ø¨ÛŒØ´ØªØ± ØµØ­Ø¨Øª Ú©Ù†ÛŒÙ…ØŸ"
                    ],
                    default: [
                        "Ù…Ù†Ø¸ÙˆØ±Øª Ø±Ùˆ Ú©Ø§Ù…Ù„ Ù…ØªÙˆØ¬Ù‡ Ù†Ø´Ø¯Ù…ØŒ Ù…ÛŒØ´Ù‡ Ú©Ù…ÛŒ Ø¨ÛŒØ´ØªØ± ØªÙˆØ¶ÛŒØ­ Ø¨Ø¯ÛŒØŸ"
                    ]
                };
                let response = responses[type]?.[Math.floor(Math.random() * (responses[type]?.length ?? 1))] || responses.default[0];
                return { type, response };
            }
            handleMath(message) {
                // Convert Persian digits to Latin
                let expr = message.replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d));
                expr = expr.replace(/Ã—/g, '*').replace(/Ã·/g, '/').replace(/[\sØŒØŸ;]/g, '');
                expr = expr.replace(/Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†|Ú†Ù‚Ø¯Ø± Ù…ÛŒØ´Ù‡/g, '').replace(/[^0-9+\-*/().]/g, '');
                let result;
                try {
                    result = Function(`"use strict"; return (${expr})`)();
                    if (isNaN(result)) throw new Error();
                } catch {
                    return { type: 'error', response: 'Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø®Ø·Ø§ Ø±Ø® Ø¯Ø§Ø¯.' };
                }
                return {
                    type: "math",
                    response: `Ø­Ø§ØµÙ„ <span class="math-expression">${expr}</span> Ø¨Ø±Ø§Ø¨Ø± Ø§Ø³Øª Ø¨Ø§ <span class="math-result">${result}</span>.`
                };
            }
            async handleSearch(message) {
                // Extract query (simple)
                const query = message.replace(/^(Ø¬Ø³ØªØ¬Ùˆ|search|Ø³Ø±Ú†|Ø¨Ú¯Ø±Ø¯|Ù¾ÛŒØ¯Ø§ Ú©Ù†|Ø¯Ø±Ø¨Ø§Ø±Ù‡|Ø¯Ø± Ù…ÙˆØ±Ø¯)/i, '').trim();
                let engine = Settings.get("searchEngine");
                let results = [];
                if (engine === "both") {
                    results = [
                        ...(await this.searchDuckDuckGo(query)),
                        ...(await this.searchWikipedia(query))
                    ];
                } else if (engine === "wikipedia") {
                    results = await this.searchWikipedia(query);
                } else {
                    results = await this.searchDuckDuckGo(query);
                }
                return {
                    type: "search",
                    response: `Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ <b>${query}</b> Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.<div class="search-results">${results.map(r=>
                        `<div class="search-result-item">
                        <div class="search-result-title">${r.title}</div>
                        <a href="${r.link}" class="search-result-link" target="_blank">${r.link}</a>
                        <div class="search-result-snippet">${r.snippet}</div></div>`
                    ).join('')}</div>`
                };
            }
            async searchDuckDuckGo(query) {
                try {
                    const r = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1`);
                    const data = await r.json();
                    if (data.AbstractText) {
                        return [{
                            title: data.Heading || `Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ "${query}"`,
                            link: `https://duckduckgo.com/?q=${encodeURIComponent(query)}`,
                            snippet: data.AbstractText
                        }];
                    }
                    // Related topics fallback
                    if (Array.isArray(data.RelatedTopics) && data.RelatedTopics.length) {
                        return data.RelatedTopics.slice(0,3).map(t=>({
                            title: t.Text || query,
                            link: t.FirstURL || `https://duckduckgo.com/?q=${encodeURIComponent(query)}`,
                            snippet: t.Text || ''
                        }));
                    }
                } catch {}
                return [{ title: "Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯", link: "#", snippet: "Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±Øª Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯." }];
            }
            async searchWikipedia(query) {
                try {
                    const r = await fetch(`https://fa.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
                    if (r.ok) {
                        const data = await r.json();
                        return [{
                            title: data.title,
                            link: data.content_urls?.desktop?.page || `https://fa.wikipedia.org/wiki/${encodeURIComponent(query)}`,
                            snippet: data.extract || "Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­"
                        }];
                    }
                } catch {}
                return [{ title: "Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯", link: "#", snippet: "Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±Øª Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯." }];
            }
        }

        // UI Controls
        const chatContainer = $("#chatContainer");
        const userInput = $("#userInput");
        const sendBtn = $("#sendBtn");
        const typingIndicator = $("#typingIndicator");
        const suggestionChips = $("#suggestionChips");
        const themeToggle = $("#themeToggle");
        const settingsBtn = $("#settingsBtn");
        const settingsPanel = $("#settingsPanel");
        const overlay = $("#overlay");
        const closeSettings = $("#closeSettings");
        const clearHistoryBtn = $("#clearHistoryBtn");
        const resetSettingsBtn = $("#resetSettingsBtn");

        // Settings form
        $("#userName").value = Settings.get("userName");
        $("#chatMode").value = Settings.get("chatMode");
        $("#responseLength").value = Settings.get("responseLength");
        $("#searchEngine").value = Settings.get("searchEngine");

        // Theme
        function applyTheme() {
            document.body.classList.toggle("dark-mode", Settings.get("darkMode"));
            themeToggle.textContent = Settings.get("darkMode") ? "â˜€ï¸" : "ğŸŒ™";
        }
        themeToggle.onclick = () => {
            Settings.set("darkMode", !Settings.get("darkMode"));
            applyTheme();
        };
        applyTheme();

        // Settings Panel
        settingsBtn.onclick = () => { settingsPanel.classList.add("active"); overlay.classList.add("active"); };
        overlay.onclick = closeSettings.onclick = () => { settingsPanel.classList.remove("active"); overlay.classList.remove("active"); };

        // Settings change
        $("#userName").oninput = e => Settings.set("userName", e.target.value);
        $("#chatMode").onchange = e => Settings.set("chatMode", e.target.value);
        $("#responseLength").onchange = e => Settings.set("responseLength", e.target.value);
        $("#searchEngine").onchange = e => Settings.set("searchEngine", e.target.value);

        resetSettingsBtn.onclick = () => {
            Settings.reset();
            window.location.reload();
        };

        // Chat History
        function renderHistory(ai) {
            chatContainer.innerHTML = '';
            ai.context.history.forEach(entry => {
                const div = document.createElement("div");
                div.className = `message ${entry.type==='user'?'user-message':'bot-message'}`;
                div.innerHTML = entry.message + `<div class="message-time">${new Date(entry.time).toLocaleTimeString('fa-IR')}</div>`;
                chatContainer.appendChild(div);
            });
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        clearHistoryBtn.onclick = () => {
            localStorage.removeItem("BKAI_history");
            ai.context.history = [];
            renderHistory(ai);
        };

        // SUGGESTION CHIPS
        suggestionChips.onclick = e => {
            if (e.target.classList.contains("suggestion-chip")) {
                userInput.value = e.target.dataset.query;
                sendBtn.click();
            }
        };

        // AI Instance (singleton)
        const ai = new UnifiedAI();
        // Restore history
        if (localStorage.BKAI_history) {
            try {
                ai.context.history = JSON.parse(localStorage.BKAI_history);
                renderHistory(ai);
            } catch {}
        }

        // Send Message
        async function sendMessage() {
            let msg = userInput.value.trim();
            if (!msg) return;
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message user-message';
            msgDiv.innerHTML = msg + `<div class="message-time">${new Date().toLocaleTimeString('fa-IR')}</div>`;
            chatContainer.appendChild(msgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            userInput.value = '';
            typingIndicator.style.display = 'block';
            await sleep(400); // typing simulation
            let result = await ai.process(msg);
            typingIndicator.style.display = 'none';
            const botDiv = document.createElement('div');
            botDiv.className = `message ${result.type}-message`;
            botDiv.innerHTML = result.response + `<div class="message-time">${new Date().toLocaleTimeString('fa-IR')}</div>`;
            chatContainer.appendChild(botDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            localStorage.BKAI_history = JSON.stringify(ai.context.history);
        }

        sendBtn.onclick = sendMessage;
        userInput.onkeydown = e => { if (e.key === 'Enter') sendBtn.click(); };

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(()=>{});
        }
    </script>
</body>
</html>
