<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ BK AI Pro</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --user-message-bg: #e3f2fd;
            --bot-message-bg: #f1f0f0;
            --math-message-bg: #e8f5e9;
            --search-message-bg: #fff3cd;
            --font-family: "Vazirmatn", "Tanha", "Segoe UI", Tahoma, sans-serif;
            --text-color: #333;
            --border-color: #ddd;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dark-mode {
            --primary-color: #5a7fb5;
            --secondary-color: #8b9cb0;
            --background-color: #1a1a1a;
            --user-message-bg: #2a4b7c;
            --bot-message-bg: #3a3a3a;
            --math-message-bg: #2d4a2d;
            --search-message-bg: #5c4b15;
            --text-color: #f0f0f0;
            --border-color: #444;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: var(--shadow);
            position: relative;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .message {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1.2rem;
            animation: fadeIn 0.3s ease;
            position: relative;
            border: 1px solid var(--border-color);
            line-height: 1.6;
            box-shadow: var(--shadow);
        }
        
        .user-message {
            align-self: flex-end;
            background-color: var(--user-message-bg);
            border-bottom-right-radius: 0.4rem;
        }
        
        .bot-message {
            align-self: flex-start;
            background-color: var(--bot-message-bg);
            border-bottom-left-radius: 0.4rem;
        }
        
        .math-message {
            align-self: flex-start;
            background-color: var(--math-message-bg);
            border-bottom-left-radius: 0.4rem;
            border-left: 4px solid #4caf50;
        }
        
        .search-message {
            align-self: flex-start;
            background-color: var(--search-message-bg);
            border-bottom-left-radius: 0.4rem;
            border-left: 4px solid #ffc107;
        }
        
        .message-time {
            font-size: 0.7rem;
            color: var(--secondary-color);
            margin-top: 0.5rem;
            text-align: right;
        }
        
        .input-container {
            display: flex;
            padding: 1rem;
            background-color: var(--bot-message-bg);
            border-top: 1px solid var(--border-color);
            gap: 0.5rem;
        }
        
        #userInput {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
            font-family: var(--font-family);
            outline: none;
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 1rem;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: border-color 0.3s;
        }
        
        #userInput:focus {
            border-color: var(--primary-color);
        }
        
        #sendBtn {
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        #sendBtn:hover {
            background-color: #3a5a80;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        #sendBtn:active {
            transform: translateY(0);
        }
        
        .typing-indicator {
            display: none;
            align-self: flex-start;
            background-color: var(--bot-message-bg);
            padding: 0.75rem 1rem;
            border-radius: 1.2rem;
            margin-bottom: 0.5rem;
            box-shadow: var(--shadow);
        }
        
        .typing-dots {
            display: flex;
            gap: 0.35rem;
        }
        
        .typing-dot {
            width: 0.6rem;
            height: 0.6rem;
            background-color: var(--secondary-color);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .settings-btn {
            position: absolute;
            left: 1rem;
            top: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
            transition: transform 0.3s;
            padding: 0.5rem;
            border-radius: 50%;
        }

        .settings-btn:hover {
            transform: rotate(45deg);
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .theme-toggle {
            position: absolute;
            right: 1rem;
            top: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
            transition: transform 0.3s;
            padding: 0.5rem;
            border-radius: 50%;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .math-expression {
            font-family: monospace;
            background-color: rgba(0, 0, 0, 0.05);
            padding: 0.2rem 0.5rem;
            border-radius: 0.3rem;
            direction: ltr;
            display: inline-block;
            margin: 0 0.2rem;
            font-weight: bold;
        }
        
        .math-result {
            font-weight: bold;
            color: #2e7d32;
            direction: ltr;
            display: inline-block;
        }
        
        .dark-mode .math-expression {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .dark-mode .math-result {
            color: #81c784;
        }
        
        .search-results {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 0.8rem;
            font-size: 0.9rem;
        }
        
        .dark-mode .search-results {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .search-result-item {
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .search-result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .search-result-title {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }
        
        .search-result-link {
            color: var(--secondary-color);
            font-size: 0.8rem;
            text-decoration: none;
            display: block;
            margin-bottom: 0.25rem;
        }
        
        .search-result-link:hover {
            text-decoration: underline;
        }
        
        .search-result-snippet {
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
        .settings-panel {
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100%;
            background: var(--bot-message-bg);
            box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            padding: 1.5rem;
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .settings-panel.active {
            left: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-color);
        }

        .close-settings {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--text-color);
            transition: transform 0.3s;
        }
        
        .close-settings:hover {
            transform: scale(1.1);
        }

        .setting-item {
            margin-bottom: 1.25rem;
        }

        .setting-item label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--text-color);
        }

        .setting-item input, .setting-item select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 1rem;
        }
        
        .setting-item select {
            cursor: pointer;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .overlay.active {
            display: block;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-family: var(--font-family);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-danger {
            background-color: #ff4757;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .suggestion-chips {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: var(--bot-message-bg);
            border-top: 1px solid var(--border-color);
            overflow-x: auto;
        }
        
        .suggestion-chip {
            padding: 0.5rem 1rem;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .suggestion-chip:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        @media (max-width: 768px) {
            .message {
                max-width: 90%;
            }
            
            .settings-panel {
                width: 85%;
                left: -85%;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .header p {
                font-size: 0.9rem;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
</head>
<body>
    <div class="header">
        <button class="settings-btn" id="settingsBtn">âš™ï¸</button>
        <button class="theme-toggle" id="themeToggle">ğŸŒ™</button>
        <h1>Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ BK AI Pro</h1>
        <p>Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø§ Ø¯Ø±Ú© Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø²Ø¨Ø§Ù† Ùˆ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¬Ø³ØªØ¬Ùˆ</p>
    </div>
    
    <div class="chat-container" id="chatContainer">
        <div class="message bot-message">
            Ø³Ù„Ø§Ù…! Ù…Ù† BK AI Pro Ù‡Ø³ØªÙ…ØŒ ÛŒÚ© Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø§ Ù‚Ø§Ø¨Ù„ÛŒØª Ø¯Ø±Ú© Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø²Ø¨Ø§Ù† Ùˆ Ø¬Ø³ØªØ¬Ùˆ. Ú†Ú¯ÙˆÙ†Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ø¨Ù‡ Ø´Ù…Ø§ Ú©Ù…Ú© Ú©Ù†Ù…ØŸ
            <div class="message-time">Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù†</div>
        </div>
    </div>
    
    <div class="suggestion-chips" id="suggestionChips">
        <div class="suggestion-chip" data-query="Ø³Ù„Ø§Ù…ØŒ Ø­Ø§Ù„Øª Ú†Ø·ÙˆØ±Ù‡ØŸ">Ø³Ù„Ø§Ù…ØŒ Ø­Ø§Ù„Øª Ú†Ø·ÙˆØ±Ù‡ØŸ</div>
        <div class="suggestion-chip" data-query="Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù† Û±Û²Ûµ Ø¶Ø±Ø¨Ø¯Ø± Û´Û³">Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù† Û±Û²Ûµ Ã— Û´Û³</div>
        <div class="suggestion-chip" data-query="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ">Ø¬Ø³ØªØ¬Ùˆ: Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</div>
        <div class="suggestion-chip" data-query="Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³ÛŒ ÛŒØ§Ø¯ Ø¨Ú¯ÛŒØ±Ù…ØŸ">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù†ÙˆÛŒØ³ÛŒ ÛŒØ§Ø¯ Ø¨Ú¯ÛŒØ±Ù…</div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    </div>
    
    <div class="input-container">
        <input type="text" id="userInput" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ ÛŒØ§ ÛŒÚ© Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø±ÛŒØ§Ø¶ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." autocomplete="off">
        <button id="sendBtn">Ø§Ø±Ø³Ø§Ù„</button>
    </div>

    <div class="overlay" id="overlay"></div>
    
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2 class="settings-title">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
            <button class="close-settings" id="closeSettings">Ã—</button>
        </div>
        
        <div class="setting-item">
            <label for="userName">Ù†Ø§Ù… Ø´Ù…Ø§</label>
            <input type="text" id="userName" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
        </div>
        
        <div class="setting-item">
            <label for="chatMode">Ù…ÙˆØ¯ Ú¯ÙØªÚ¯Ùˆ</label>
            <select id="chatMode">
                <option value="normal">Ø¹Ø§Ø¯ÛŒ</option>
                <option value="friendly">Ø¯ÙˆØ³ØªØ§Ù†Ù‡ ğŸ¤</option>
                <option value="professional">Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ğŸ’¼</option>
                <option value="funny">Ø®Ù†Ø¯Ù‡ Ø¯Ø§Ø± ğŸ˜‚</option>
            </select>
        </div>
        
        <div class="setting-item">
            <label for="responseLength">Ø·ÙˆÙ„ Ù¾Ø§Ø³Ø®</label>
            <select id="responseLength">
                <option value="short">Ú©ÙˆØªØ§Ù‡</option>
                <option value="medium" selected>Ù…ØªÙˆØ³Ø·</option>
                <option value="long">Ø·ÙˆÙ„Ø§Ù†ÛŒ</option>
            </select>
        </div>
        
        <div class="setting-item">
            <label for="searchEngine">Ù…ÙˆØªÙˆØ± Ø¬Ø³ØªØ¬Ùˆ</label>
            <select id="searchEngine">
                <option value="duckduckgo">DuckDuckGo</option>
                <option value="wikipedia">ÙˆÛŒÚ©ÛŒâ€ŒÙ¾Ø¯ÛŒØ§</option>
                <option value="both">Ù‡Ø± Ø¯Ùˆ</option>
            </select>
        </div>
        
        <div class="setting-item">
            <button id="clearHistoryBtn" class="btn btn-danger" style="width: 100%">
                Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú¯ÙØªÚ¯Ùˆ
            </button>
        </div>
        
        <div class="setting-item">
            <button id="resetSettingsBtn" class="btn" style="width: 100%; background-color: var(--secondary-color); color: white">
                Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
            </button>
        </div>
    </div>

    <script>
        // ====== Ø³ÛŒØ³ØªÙ… Ø¯Ø±Ú© Ø²Ø¨Ø§Ù† Ø·Ø¨ÛŒØ¹ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ======
        class AdvancedNLP {
            constructor() {
                this.context = {
                    userName: null,
                    lastTopics: [],
                    userInterests: [],
                    conversationHistory: []
                };
                this.setupPatterns();
            }
            
            setupPatterns() {
                this.patterns = [
                    // Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø³Ù„Ø§Ù… Ùˆ Ø§Ø­ÙˆØ§Ù„Ù¾Ø±Ø³ÛŒ
                    {
                        pattern: /(Ø³Ù„Ø§Ù…|Ø¯Ø±ÙˆØ¯|Ù‡ÛŒ|ØµØ¨Ø­ Ø¨Ø®ÛŒØ±|Ø¹ØµØ± Ø¨Ø®ÛŒØ±|Ø´Ø¨ Ø¨Ø®ÛŒØ±|hello|hi|hey)/i,
                        category: "greeting",
                        responses: [
                            "Ø³Ù„Ø§Ù…! Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú© Ú©Ù†Ù…ØŸ",
                            "Ø¯Ø±ÙˆØ¯ Ø¨Ø± Ø´Ù…Ø§! Ø­Ø§Ù„ØªÙˆÙ† Ú†Ø·ÙˆØ±Ù‡ØŸ",
                            "Ø³Ù„Ø§Ù…! Ø®ÙˆØ´Ø­Ø§Ù„Ù… Ú©Ù‡ Ø¨Ø§Ù‡Ø§Øª ØµØ­Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†Ù….",
                            "Ù‡ÛŒ! Ú†Ù‡ Ø®Ø¨Ø±ØŸ Ú†Ø·ÙˆØ± Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ú©Ù…Ú©Øª Ú©Ù†Ù…ØŸ"
                        ]
                    },
                    // Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ ØªØ´Ú©Ø±
                    {
                        pattern: /(Ù…Ù…Ù†ÙˆÙ†|Ù…Ø±Ø³ÛŒ|ØªØ´Ú©Ø±|Ø¯Ø³Øª Ù…Ø±ÛŒØ²Ø§Ø¯|Ù…Ù…Ù†ÙˆÙ†Ù…|Ø¨Ø§ØªØ´Ú©Ø±|thanks|thank you)/i,
                        category: "thanks",
                        responses: [
                            "Ø®ÙˆØ§Ù‡Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ù…!",
                            "Ù‚Ø§Ø¨Ù„ÛŒ Ù†Ø¯Ø§Ø´Øª!",
                            "Ø®ÙˆØ´Ø­Ø§Ù„Ù… Ú©Ù‡ ØªÙˆÙ†Ø³ØªÙ… Ú©Ù…Ú© Ú©Ù†Ù…!",
                            "Ù‡Ù…ÛŒØ´Ù‡ Ø¯Ø± Ø®Ø¯Ù…Øª Ø´Ù…Ø§ Ù‡Ø³ØªÙ…!",
                            "Ø®ÙˆØ´Ø­Ø§Ù„Ù… Ú©Ù‡ Ø±Ø§Ø¶ÛŒØªÙˆÙ† Ú©Ø±Ø¯Ù…!"
                        ]
                    },
                    // Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ù¾Ø±Ø³Ø´ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø®ÙˆØ¯ Ø±Ø¨Ø§Øª
                    {
                        pattern: /(ØªÙˆ Ú©ÛŒØ³ØªÛŒ|Ø§Ø³Ù… ØªÙˆ Ú†ÛŒÙ‡|ØªÙˆ Ú†ÛŒ Ù‡Ø³ØªÛŒ|ØªÙˆ Ú†ÛŒØ³Øª|ä½ æ˜¯è°|what are you|who are you)/i,
                        category: "about_bot",
                        responses: [
                            "Ù…Ù† BK AI Pro Ù‡Ø³ØªÙ…ØŒ ÛŒÚ© Ú†Øªâ€ŒØ¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ú©Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ù…Ú© Ø¨Ù‡ Ø´Ù…Ø§ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡â€ŒØ§Ù….",
                            "Ø§Ø³Ù… Ù…Ù† BK AI Pro Ù‡Ø³Øª. Ù…Ù† ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯Ù… Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø¨Ø§Ù‡Ø§Øª ØµØ­Ø¨Øª Ú©Ù†Ù… Ùˆ Ú©Ù…Ú©Øª Ú©Ù†Ù….",
                            "Ù…Ù† ÛŒÚ© Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù‡Ø³ØªÙ… Ú©Ù‡ Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ø´Ù…Ø§ Ù¾Ø§Ø³Ø® Ø¨Ø¯Ù… Ùˆ Ø¨Ø§Ù‡Ø§Øª Ú¯ÙØªÚ¯Ùˆ Ú©Ù†Ù…."
                        ]
                    },
                    // Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ù¾Ø±Ø³Ø´ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±
                    {
                        pattern: /(Ø§Ø³Ù…Ù…|Ù†Ø§Ù…Ù…|Ù…Ù† (.+) Ù‡Ø³ØªÙ…|Ø§Ø³Ù… Ù…Ù†|my name is|I am)/i,
                        category: "user_name",
                        responses: [
                            "Ú†Ù‡ Ø§Ø³Ù… Ù‚Ø´Ù†Ú¯ÛŒ! Ø®ÙˆØ´Ø­Ø§Ù„Ù… Ú©Ù‡ Ø¨Ø§Ù‡Ø§Øª Ø¢Ø´Ù†Ø§ Ø´Ø¯Ù….",
                            "Ø§Ø³Ù… Ø®ÙˆØ¨ÛŒ Ø¯Ø§Ø±ÛŒ! Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ.",
                            "Ú†Ù‡ Ø§Ø³Ù… Ø²ÛŒØ¨Ø§ÛŒÛŒ! Ø®ÙˆØ´Ø­Ø§Ù„Ù… Ú©Ù‡ Ø¨Ø§Ù‡Ø§Øª ØµØ­Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†Ù…."
                        ],
                        extractor: (message) => {
                            const matches = message.match(/(Ø§Ø³Ù…Ù…|Ù†Ø§Ù…Ù…|Ù…Ù†) (.+) (Ù‡Ø³ØªÙ…|Ø§Ø³Øª|am|is)/i);
                            return matches ? matches[2] : null;
                        }
                    },
                    // Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ù¾Ø±Ø³Ø´ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø²Ù…Ø§Ù†
                    {
                        pattern: /(Ø³Ø§Ø¹Øª Ú†Ù†Ø¯Ù‡|ÙˆÙ‚Øª Ú†Ù†Ø¯Ù‡|å‡ ç‚¹äº†|what time|what is the time)/i,
                        category: "time",
                        responses: [
                            "Ù‡Ù…ÛŒÙ† Ø§Ù„Ø§Ù† Ø³Ø§Ø¹Øª {{time}} Ù‡Ø³Øª.",
                            "Ø§Ù„Ø§Ù† Ø³Ø§Ø¹Øª {{time}} Ù‡Ø³Øª.",
                            "Ø³Ø§Ø¹Øª {{time}} Ù‡Ø³Øª."
                        ]
                    },
                    // Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ù¾Ø±Ø³Ø´ Ø¯Ø±Ø¨Ø§Ø±Ù‡ ØªØ§Ø±ÛŒØ®
                    {
                        pattern: /(Ø§Ù…Ø±ÙˆØ² Ú†Ù†Ø¯Ù…Ù‡|ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ²|ä»Šå¤©æ˜¯|what date|what is the date)/i,
                        category: "date",
                        responses: [
                            "Ø§Ù…Ø±ÙˆØ² {{date}} Ù‡Ø³Øª.",
                            "Ø§Ù„Ø§Ù† {{date}} Ù‡Ø³Øª.",
                            "ØªØ§Ø±ÛŒØ® Ø§Ù…Ø±ÙˆØ²: {{date}}"
                        ]
                    },
                    // Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø®Ø¯Ø§Ø­Ø§ÙØ¸ÛŒ
                    {
                        pattern: /(Ø®Ø¯Ø§Ø­Ø§ÙØ¸|Ø¨Ø§ÛŒ|Ø®Ø¯Ø§Ù†Ú¯Ù‡Ø¯Ø§Ø±|bye|goodbye|see you)/i,
                        category: "goodbye",
                        responses: [
                            "Ø®Ø¯Ø§Ø­Ø§ÙØ¸! Ø§Ù…ÛŒØ¯ÙˆØ§Ø±Ù… Ø¨Ø§Ø²Ù… Ø¨Ø¨ÛŒÙ†Ù…Øª.",
                            "Ø¨Ø§ÛŒ! Ø±ÙˆØ² Ø®ÙˆØ¨ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒ.",
                            "Ø®Ø¯Ø§Ù†Ú¯Ù‡Ø¯Ø§Ø±! Ù‡Ù…ÛŒØ´Ù‡ Ø³Ù„Ø§Ù…Øª Ø¨Ø§Ø´ÛŒ."
                        ]
                    },
                    // Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø³ÙˆØ§Ù„Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ
                    {
                        pattern: /(Ú†Ø·ÙˆØ±|Ú†Ú¯ÙˆÙ†Ù‡|Ú†Ø±Ø§|Ú†ÛŒ|Ú†Ù‡|Ú©ÛŒ|Ú©Ø¬Ø§|Ú†Ù†Ø¯|how|why|what|when|where|which|who)/i,
                        category: "question",
                        responses: [
                            "Ø³ÙˆØ§Ù„ Ø¬Ø§Ù„Ø¨ÛŒ Ù¾Ø±Ø³ÛŒØ¯ÛŒ. ÙÚ©Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù… Ø¬ÙˆØ§Ø¨Ø´ Ø§ÛŒÙ† Ø¨Ø§Ø´Ù‡ Ú©Ù‡...",
                            "Ø®Ø¨ØŒ Ø§ÛŒÙ† Ø¨Ø³ØªÚ¯ÛŒ Ø¨Ù‡ Ø¹ÙˆØ§Ù…Ù„ Ù…Ø®ØªÙ„ÙÛŒ Ø¯Ø§Ø±Ù‡...",
                            "Ø§Ø² Ø¯ÛŒØ¯Ú¯Ø§Ù‡ Ù…Ù†ØŒ Ù…ÛŒØ´Ù‡ Ø§ÛŒÙ†Ø·ÙˆØ±çœ‹å¾… Ú©Ø±Ø¯ Ú©Ù‡...",
                            "Ø¨Ù‡ Ù†Ø¸Ø± Ù…Ù†ØŒ Ø§ÛŒÙ† Ù…ÙˆØ¶ÙˆØ¹ Ø±Ùˆ Ù…ÛŒØ´Ù‡ Ø§Ø² Ú†Ù†Ø¯ Ø¬Ù†Ø¨Ù‡ Ù…Ø®ØªÙ„Ù Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø±Ø¯..."
                        ]
                    },
                    // Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø§Ø­Ø³Ø§Ø³Ø§Øª
                    {
                        pattern: /(Ø®ÙˆØ´Ø­Ø§Ù„Ù…|ØºÙ…Ú¯ÛŒÙ†Ù…|Ø¹ØµØ¨Ø§Ù†ÛŒÙ…|Ø®Ø³ØªÙ…|Ø§Ø³ØªØ±Ø³ Ø¯Ø§Ø±Ù…|Ù†Ø§Ø±Ø§Ø­ØªÙ…|Ù†Ú¯Ø±Ø§Ù†Ù…|happy|sad|angry|tired)/i,
                        category: "emotion",
                        responses: [
                            "Ù…ØªÙˆØ¬Ù‡ Ø§Ø­Ø³Ø§Ø³Øª Ù…ÛŒØ´Ù…. Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø¯Ø± Ù…ÙˆØ±Ø¯Ø´ Ø¨ÛŒØ´ØªØ± ØµØ­Ø¨Øª Ú©Ù†ÛŒÙ…ØŸ",
                            "Ø§Ø­Ø³Ø§Ø³Ø§ØªØª Ø±Ùˆ Ø¯Ø±Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù…. Ø§Ú¯Ø± Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒØŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒÙ… Ø¨ÛŒØ´ØªØ± Ø­Ø±Ù Ø¨Ø²Ù†ÛŒÙ….",
                            "Ù…Ù…Ù†ÙˆÙ† Ú©Ù‡ Ø§Ø­Ø³Ø§Ø³Ø§ØªØª Ø±Ùˆ Ø¨Ø§ Ù…Ù† Ø¯Ø± Ù…ÛŒØ§Ù† Ú¯Ø°Ø§Ø´ØªÛŒ. Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒ Ø¨ÛŒØ´ØªØ± ØµØ­Ø¨Øª Ú©Ù†ÛŒÙ…ØŸ"
                        ]
                    },
                    // Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ
                    {
                        pattern: /(Ø¬Ø³ØªØ¬Ùˆ|Ø³Ø±Ú†|search|Ø¨Ú¯Ø±Ø¯|Ù¾ÛŒØ¯Ø§ Ú©Ù†|Ø¯Ø±Ø¨Ø§Ø±Ù‡ (.+) Ø§Ø·Ù„Ø§Ø¹Ø§Øª|Ø¯Ø± Ù…ÙˆØ±Ø¯ (.+) Ø¨Ú¯Ùˆ|search for|about )/i,
                        category: "search",
                        responses: [
                            "Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ '{{query}}'...",
                            "Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒØŒ Ø¯Ø§Ø±Ù… '{{query}}' Ø±Ùˆ Ø¬Ø³ØªØ¬Ùˆ Ù…ÛŒâ€ŒÚ©Ù†Ù…...",
                            "Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ '{{query}}' Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒØ´Ù‡..."
                        ],
                        extractor: (message) => {
                            const searchPatterns = [
                                /Ø¬Ø³ØªØ¬Ùˆ (?:Ø¯Ø± Ù…ÙˆØ±Ø¯|Ø¨Ø±Ø§ÛŒ) (.+)/i,
                                /Ø³Ø±Ú† (?:Ú©Ù†|Ø¨Ø±Ø§ÛŒ) (.+)/i,
                                /Ø¯Ø±Ø¨Ø§Ø±Ù‡ (.+) Ø§Ø·Ù„Ø§Ø¹Ø§Øª/i,
                                /Ø¯Ø± Ù…ÙˆØ±Ø¯ (.+) Ø¨Ú¯Ùˆ/i,
                                /search for (.+)/i,
                                /about (.+)/i
                            ];
                            
                            for (const pattern of searchPatterns) {
                                const match = message.match(pattern);
                                if (match && match[1]) {
                                    return match[1];
                                }
                            }
                            
                            return message;
                        }
                    },
                    // Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø±ÛŒØ§Ø¶ÛŒ
                    {
                        pattern: /(Ù…Ø­Ø§Ø³Ø¨Ù‡|Ø­Ø³Ø§Ø¨|Ø±ÛŒØ§Ø¶ÛŒ|math|calculate|Ú†Ù‚Ø¯Ø± Ù…ÛŒØ´Ù‡|Ú†Ù†Ø¯Ù‡|Ø¶Ø±Ø¨|ØªÙ‚Ø³ÛŒÙ…|Ø¬Ù…Ø¹|ØªÙØ±ÛŒÙ‚|\+|\-|\Ã—|\Ã·|\*|\/)/i,
                        category: "math",
                        responses: [
                            "Ø­Ø§ØµÙ„ {{expression}} Ø¨Ø±Ø§Ø¨Ø± Ø§Ø³Øª Ø¨Ø§ {{result}}.",
                            "Ù†ØªÛŒØ¬Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡: {{expression}} = {{result}}",
                            "Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯: {{expression}} = {{result}}"
                        ]
                    }
                ];
            }
            
            processMessage(message) {
                // Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…
                const preprocessed = this.preprocessMessage(message);
                
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú¯ÙØªÚ¯Ùˆ
                this.context.conversationHistory.push({
                    type: 'user',
                    message: message,
                    time: new Date()
                });
                
                // ØªØ´Ø®ÛŒØµ Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù…
                const messageType = this.detectMessageType(preprocessed);
                
                // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù…
                let result;
                switch(messageType) {
                    case 'math':
                        result = this.processMathExpression(preprocessed);
                        break;
                    case 'search':
                        result = this.processSearchQuery(preprocessed);
                        break;
                    default:
                        result = this.generateResponse(messageType, preprocessed);
                }
                
                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾Ø§Ø³Ø® Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú¯ÙØªÚ¯Ùˆ
                this.context.conversationHistory.push({
                    type: 'bot',
                    message: result.response,
                    time: new Date()
                });
                
                return result;
            }
            
            preprocessMessage(message) {
                // ØªØ¨Ø¯ÛŒÙ„ Ø§Ø¹Ø¯Ø§Ø¯ ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø±ÛŒØ§Ø¶ÛŒ
                let processed = message.replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d));
                
                // Ø­Ø°Ù Ú©Ø§Ø±Ø§Ú©ØªØ±Ù‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ
                processed = processed.replace(/[ØŸ?ØŒ,;Ø›]/g, '');
                
                return processed;
            }
            
            detectMessageType(message) {
                const lowerMessage = message.toLowerCase();
                
                // ØªØ´Ø®ÛŒØµ Ø¹Ø¨Ø§Ø±Ø§Øª Ø±ÛŒØ§Ø¶ÛŒ
                if (this.isMathExpression(lowerMessage)) {
                    return 'math';
                }
                
                // ØªØ´Ø®ÛŒØµ Ø¬Ø³ØªØ¬Ùˆ
                if (/(Ø¬Ø³ØªØ¬Ùˆ|Ø³Ø±Ú†|search|Ø¨Ú¯Ø±Ø¯|Ù¾ÛŒØ¯Ø§ Ú©Ù†|Ø¯Ø±Ø¨Ø§Ø±Ù‡ (.+) Ø§Ø·Ù„Ø§Ø¹Ø§Øª|Ø¯Ø± Ù…ÙˆØ±Ø¯ (.+) Ø¨Ú¯Ùˆ|search for|about )/i.test(lowerMessage)) {
                    return 'search';
                }
                
                // ØªØ´Ø®ÛŒØµ Ø³Ø§ÛŒØ± Ø§Ù†ÙˆØ§Ø¹ Ù¾ÛŒØ§Ù…
                for (const patternObj of this.patterns) {
                    if (patternObj.pattern.test(message)) {
                        return patternObj.category;
                    }
                }
                
                return 'default';
            }
            
            isMathExpression(message) {
                // ØªØ´Ø®ÛŒØµ Ø¹Ø¨Ø§Ø±Ø§Øª Ø±ÛŒØ§Ø¶ÛŒ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² regex
                const mathRegex = /(\d+\s*[\+\-\Ã—\Ã·\*\/().]\s*)+\d+/;
                const persianMathRegex = /(Ú†Ù‚Ø¯Ø± Ù…ÛŒØ´Ù‡|Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†|Ø­Ø§ØµÙ„|Ù…Ø³Ø§ÙˆÛŒ|Ø¨Ø±Ø§Ø¨Ø±|Ø¨Ù‡ Ø§Ø¶Ø§ÙÙ‡|Ù…Ù†Ù‡Ø§ÛŒ|Ø¶Ø±Ø¨ Ø¯Ø±|ØªÙ‚Ø³ÛŒÙ… Ø¨Ø±)/;
                
                return mathRegex.test(message) || persianMathRegex.test(message);
            }
            
            processMathExpression(message) {
                try {
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ
                    let mathExpr = this.extractMathExpression(message);
                    
                    // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ø¹Ù…Ù„Ú¯Ø±Ù‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø¨Ø§ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
                    mathExpr = mathExpr.replace(/Ã—/g, '*')
                                      .replace(/Ã·/g, '/')
                                      .replace(/Ø¨Ù‡ Ø§Ø¶Ø§ÙÙ‡/gi, '+')
                                      .replace(/Ù…Ù†Ù‡Ø§ÛŒ/gi, '-')
                                      .replace(/Ø¶Ø±Ø¨ Ø¯Ø±/gi, '*')
                                      .replace(/ØªÙ‚Ø³ÛŒÙ… Ø¨Ø±/gi, '/');
                    
                    // Ø­Ø°Ù ÙØ¶Ø§Ù‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ
                    mathExpr = mathExpr.replace(/\s+/g, '');
                    
                    // Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ
                    const result = this.safeEval(mathExpr);
                    
                    // ØªÙˆÙ„ÛŒØ¯ Ù¾Ø§Ø³Ø®
                    const response = this.generateResponse('math', message)
                                        .replace('{{expression}}', mathExpr)
                                        .replace('{{result}}', result);
                    
                    return {
                        type: 'math',
                        expression: mathExpr,
                        result: result,
                        response: response
                    };
                } catch (error) {
                    return {
                        type: 'error',
                        response: 'Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±Øª Ø±Ø§ Ø¨Ù‡ Ø´Ú©Ù„ Ø¯ÛŒÚ¯Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'
                    };
                }
            }
            
            processSearchQuery(message) {
                try {
                    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¹Ø¨Ø§Ø±Øª Ø¬Ø³ØªØ¬Ùˆ
                    const query = this.extractSearchQuery(message);
                    
                    // ØªÙˆÙ„ÛŒØ¯ Ù¾Ø§Ø³Ø®
                    const response = this.generateResponse('search', message)
                                        .replace('{{query}}', query);
                    
                    return {
                        type: 'search',
                        query: query,
                        response: response
                    };
                } catch (error) {
                    return {
                        type: 'error',
                        response: 'Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø³ØªØ¬Ùˆ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±Øª Ø±Ø§ Ø¨Ù‡ Ø´Ú©Ù„ Ø¯ÛŒÚ¯Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.'
                    };
                }
            }
            
            extractMathExpression(message) {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ Ø§Ø² Ù¾ÛŒØ§Ù…
                const mathRegex = /((\d+[\+\-\*\/\(\)].*)|\d+)/;
                const match = message.match(mathRegex);
                
                if (match) {
                    return match[0];
                }
                
                // Ø§Ú¯Ø± Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø³Ø¹ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø§Ø² Ù¾ÛŒØ§Ù… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ù†ÛŒÙ…
                if (message.includes('Ú†Ù‚Ø¯Ø± Ù…ÛŒØ´Ù‡')) {
                    return message.replace('Ú†Ù‚Ø¯Ø± Ù…ÛŒØ´Ù‡', '').trim();
                }
                
                if (message.includes('Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†')) {
                    return message.replace('Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†', '').trim();
                }
                
                return message;
            }
            
            extractSearchQuery(message) {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¹Ø¨Ø§Ø±Øª Ø¬Ø³ØªØ¬Ùˆ Ø§Ø² Ù¾ÛŒØ§Ù…
                const searchPatterns = [
                    /Ø¬Ø³ØªØ¬Ùˆ (?:Ø¯Ø± Ù…ÙˆØ±Ø¯|Ø¨Ø±Ø§ÛŒ) (.+)/i,
                    /Ø³Ø±Ú† (?:Ú©Ù†|Ø¨Ø±Ø§ÛŒ) (.+)/i,
                    /Ø¯Ø±Ø¨Ø§Ø±Ù‡ (.+) Ø§Ø·Ù„Ø§Ø¹Ø§Øª/i,
                    /Ø¯Ø± Ù…ÙˆØ±Ø¯ (.+) Ø¨Ú¯Ùˆ/i,
                    /search for (.+)/i,
                    /about (.+)/i
                ];
                
                for (const pattern of searchPatterns) {
                    const match = message.match(pattern);
                    if (match && match[1]) {
                        return match[1];
                    }
                }
                
                return message;
            }
            
            safeEval(expr) {
                // Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø§ÛŒÙ…Ù† Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ
                try {
                    // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ø¹Ù…Ù„Ú¯Ø±Ù‡Ø§ÛŒ ØºÛŒØ±Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯
                    expr = expr.replace(/[^0-9+\-*/().]/g, '');
                    
                    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Function Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø§ÛŒÙ…Ù†
                    return Function(`"use strict"; return (${expr})`)();
                } catch (error) {
                    throw new Error('Ø¹Ø¨Ø§Ø±Øª Ø±ÛŒØ§Ø¶ÛŒ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                }
            }
            
            generateResponse(type, message) {
                // ÛŒØ§ÙØªÙ† Ø§Ù„Ú¯ÙˆÛŒ Ù…Ù†Ø§Ø³Ø¨
                const patternObj = this.patterns.find(p => p.category === type);
                
                if (patternObj && patternObj.responses) {
                    const responseList = patternObj.responses;
                    const randomIndex = Math.floor(Math.random() * responseList.length);
                    let response = responseList[randomIndex];
                    
                    // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ dynamic values
                    if (type === "time") {
                        const now = new Date();
                        const time = now.toLocaleTimeString('fa-IR');
                        response = response.replace("{{time}}", time);
                    } else if (type === "date") {
                        const now = new Date();
                        const date = now.toLocaleDateString('fa-IR');
                        response = response.replace("{{date}}", date);
                    } else if (type === "user_name" && patternObj.extractor) {
                        const userName = patternObj.extractor(message);
                        if (userName) {
                            this.context.userName = userName;
                            response = response.replace("{{userName}}", userName);
                        }
                    }
                    
                    return response;
                }
                
                // Ù¾Ø§Ø³Ø® Ù¾ÛŒØ´â€ŒÙØ±Ø¶
                const defaultResponses = [
                    "Ø¬Ø§Ù„Ø¨ Ø¨ÙˆØ¯! Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ Ø¨ÛŒØ´ØªØ± Ø¯Ø± Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ ØµØ­Ø¨Øª Ú©Ù†ÛŒÙ…ØŸ",
                    "Ù…Ù†Ø¸ÙˆØ±Øª Ø±Ùˆ Ú©Ø§Ù…Ù„ Ù…ØªÙˆØ¬Ù‡ Ù†Ø´Ø¯Ù…ØŒ Ù…ÛŒØ´Ù‡ Ú©Ù…ÛŒ Ø¨ÛŒØ´ØªØ± ØªÙˆØ¶ÛŒØ­ Ø¨Ø¯ÛŒØŸ",
                    "Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ø§ÛŒÙ† Ù…ÙˆØ¶ÙˆØ¹ Ù…Ø·Ù…Ø¦Ù† Ù†ÛŒØ³ØªÙ…ØŒ Ù…ÛŒØªÙˆÙ†ÛŒ ÛŒÙ‡ Ú©Ù… Ø¨ÛŒØ´ØªØ± ØªÙˆØ¶ÛŒØ­ Ø¨Ø¯ÛŒØŸ",
                    "Ø¬Ø§Ù„Ø¨ Ø§Ø³Øª! Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒ Ø¨ÛŒØ´ØªØ± Ø¯Ø± Ø§ÛŒÙ† Ù…ÙˆØ±Ø¯ ØµØ­Ø¨Øª Ú©Ù†ÛŒÙ…ØŸ",
                    "Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø³ÙˆØ§Ù„Øª Ø±Ùˆ Ø¨Ù‡ Ø´Ú©Ù„ Ø¯ÛŒÚ¯Ø±ÛŒ Ø¨Ù¾Ø±Ø³ÛŒØŸ Ø´Ø§ÛŒØ¯ Ø¨Ù‡ØªØ± Ø¨ØªÙˆÙ†Ù… Ú©Ù…Ú©Øª Ú©Ù†Ù…."
                ];
                
                return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
            }
        }

        // ====== Ø³ÛŒØ³ØªÙ… Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ======
        class SearchEngine {
            constructor() {
                this.providers = ['duckduckgo', 'wikipedia'];
            }
            
            async search(query, provider = 'duckduckgo') {
                try {
                    if (provider === 'duckduckgo') {
                        return await this.searchDuckDuckGo(query);
                    } else if (provider === 'wikipedia') {
                        return await this.searchWikipedia(query);
                    }
                } catch (error) {
                    console.error('Error in search:', error);
                    return [{
                        title: 'Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ',
                        link: '#',
                        snippet: 'Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø¯Ø± Ø§Ù†Ø¬Ø§Ù… Ø¬Ø³ØªØ¬Ùˆ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯Ù‡ Ø§Ø³Øª.',
                        source: 'System'
                    }];
                }
            }
            
            async searchDuckDuckGo(query) {
                try {
                    const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`);
                    
                    if (!response.ok) {
                        throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.AbstractText) {
                        return [{
                            title: data.Heading || `Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ "${query}"`,
                            link: `https://duckduckgo.com/?q=${encodeURIComponent(query)}`,
                            snippet: data.AbstractText,
                            source: "DuckDuckGo"
                        }];
                    } else {
                        return [{
                            title: `Ù‡ÛŒÚ† Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ "${query}" ÛŒØ§ÙØª Ù†Ø´Ø¯`,
                            link: `https://duckduckgo.com/?q=${encodeURIComponent(query)}`,
                            snippet: "Ù„Ø·ÙØ§Ù‹ query Ø¬Ø³ØªØ¬ÙˆÛŒ Ø®ÙˆØ¯ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯.",
                            source: "DuckDuckGo"
                        }];
                    }
                } catch (error) {
                    console.error('Error fetching from DuckDuckGo:', error);
                    return [{
                        title: `Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ "${query}"`,
                        link: `https://duckduckgo.com/?q=${encodeURIComponent(query)}`,
                        snippet: "Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†ØªØ§ÛŒØ¬ Ú©Ø§Ù…Ù„ Ø¨Ø± Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.",
                        source: "DuckDuckGo"
                    }];
                }
            }
            
            async searchWikipedia(query) {
                try {
                    const response = await fetch(`https://fa.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(query)}&format=json&origin=*`);
                    
                    if (!response.ok) {
                        throw new Error(`Ø®Ø·Ø§ÛŒ HTTP: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.query.search.length > 0) {
                        return data.query.search.slice(0, 3).map(item => ({
                            title: item.title,
                            link: `https://fa.wikipedia.org/wiki/${encodeURIComponent(item.title)}`,
                            snippet: item.snippet,
                            source: "ÙˆÛŒÚ©ÛŒâ€ŒÙ¾Ø¯ÛŒØ§"
                        }));
                    } else {
                        return [{
                            title: `Ù‡ÛŒÚ† Ù…Ù‚Ø§Ù„Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ "${query}" ÛŒØ§ÙØª Ù†Ø´Ø¯`,
                            link: `https://fa.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(query)}`,
                            snippet: "Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¹Ø¨Ø§Ø±Øª Ø¯Ø± ÙˆÛŒÚ©ÛŒâ€ŒÙ¾Ø¯ÛŒØ§ Ù…Ù‚Ø§Ù„Ù‡â€ŒØ§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯.",
                            source: "ÙˆÛŒÚ©ÛŒâ€ŒÙ¾Ø¯ÛŒØ§"
                        }];
                    }
                } catch (error) {
                    console.error('Error fetching from Wikipedia:', error);
                    return [{
                        title: `Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ "${query}"`,
                        link: `https://fa.wikipedia.org/wiki/Special:Search?search=${encodeURIComponent(query)}`,
                        snippet: "Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù†ØªØ§ÛŒØ¬ Ú©Ø§Ù…Ù„ Ø¨Ø± Ø±ÙˆÛŒ Ù„ÛŒÙ†Ú© Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.",
                        source: "ÙˆÛŒÚ©ÛŒâ€ŒÙ¾Ø¯ÛŒØ§"
                    }];
                }
            }
        }

        // ====== Ù…Ø¯ÛŒØ±ÛŒØª Ú†Øªâ€ŒØ¨Ø§Øª ======
        class ChatManager {
            constructor() {
                this.nlp = new AdvancedNLP();
                this.searchEngine = new SearchEngine();
                this.settings = {
                    userName: 'Ú©Ø§Ø±Ø¨Ø±',
                    chatMode: 'normal',
                    responseLength: 'medium',
                    searchEngine: 'duckduckgo',
                    theme: 'light'
                };
                
                this.setupEventListeners();
                this.loadSettings();
                this.applySettings();
            }
            
            setupEventListeners() {
                const sendBtn = document.getElementById('sendBtn');
                const userInput = document.getElementById('userInput');
                const themeToggle = document.getElementById('themeToggle');
                const settingsBtn = document.getElementById('settingsBtn');
                const closeSettings = document.getElementById('closeSettings');
                const overlay = document.getElementById('overlay');
                
                sendBtn.addEventListener('click', () => this.sendMessage());
                userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                
                themeToggle.addEventListener('click', () => this.toggleTheme());
                
                // Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù†Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                settingsBtn.addEventListener('click', () => this.toggleSettingsPanel(true));
                closeSettings.addEventListener('click', () => this.toggleSettingsPanel(false));
                overlay.addEventListener('click', () => this.toggleSettingsPanel(false));
                
                // Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª Ø³Ø±ÛŒØ¹
                const suggestionChips = document.getElementById('suggestionChips');
                suggestionChips.addEventListener('click', (e) => {
                    if (e.target.classList.contains('suggestion-chip')) {
                        const query = e.target.getAttribute('data-query');
                        document.getElementById('userInput').value = query;
                        this.sendMessage();
                    }
                });
                
                // Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª
                document.getElementById('userName').addEventListener('change', (e) => {
                    this.settings.userName = e.target.value;
                    this.saveSettings();
                });
                
                document.getElementById('chatMode').addEventListener('change', (e) => {
                    this.settings.chatMode = e.target.value;
                    this.saveSettings();
                });
                
                document.getElementById('responseLength').addEventListener('change', (e) => {
                    this.settings.responseLength = e.target.value;
                    this.saveSettings();
                });
                
                document.getElementById('searchEngine').addEventListener('change', (e) => {
                    this.settings.searchEngine = e.target.value;
                    this.saveSettings();
                });
                
                document.getElementById('clearHistoryBtn').addEventListener('click', () => this.clearHistory());
                document.getElementById('resetSettingsBtn').addEventListener('click', () => this.resetSettings());
            }
            
            sendMessage() {
                const userInput = document.getElementById('userInput');
                const message = userInput.value.trim();
                
                if (message === '') return;
                
                this.addMessage(message, 'user');
                userInput.value = '';
                
                this.showTypingIndicator();
                
                // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù… Ø¨Ø§ ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø·Ø¨ÛŒØ¹ÛŒâ€ŒØªØ± Ø´Ø¯Ù†
                setTimeout(() => {
                    this.hideTypingIndicator();
                    this.processMessage(message);
                }, 1000 + Math.random() * 1000);
            }
            
            async processMessage(message) {
                const result = this.nlp.processMessage(message);
                
                if (result.type === 'math') {
                    this.addMathMessage(result.response, result.expression, result.result);
                } else if (result.type === 'search') {
                    this.addMessage(result.response, 'bot');
                    this.showTypingIndicator();
                    
                    // Ø§Ù†Ø¬Ø§Ù… Ø¬Ø³ØªØ¬Ùˆ
                    const searchResults = await this.searchEngine.search(result.query, this.settings.searchEngine);
                    
                    this.hideTypingIndicator();
                    this.addSearchResults(searchResults, result.query);
                } else {
                    this.addMessage(result.response, 'bot');
                }
            }
            
            addMessage(text, type) {
                const chatContainer = document.getElementById('chatContainer');
                const messageDiv = document.createElement('div');
                
                messageDiv.classList.add('message', type === 'user' ? 'user-message' : 'bot-message');
                
                const messageText = document.createElement('div');
                messageText.innerHTML = text;
                messageDiv.appendChild(messageText);
                
                const messageTime = document.createElement('div');
                messageTime.classList.add('message-time');
                messageTime.textContent = new Date().toLocaleTimeString('fa-IR');
                messageDiv.appendChild(messageTime);
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            addMathMessage(text, expression, result) {
                const chatContainer = document.getElementById('chatContainer');
                const messageDiv = document.createElement('div');
                
                messageDiv.classList.add('message', 'math-message');
                
                const messageText = document.createElement('div');
                messageText.innerHTML = text;
                messageDiv.appendChild(messageText);
                
                const messageTime = document.createElement('div');
                messageTime.classList.add('message-time');
                messageTime.textContent = new Date().toLocaleTimeString('fa-IR');
                messageDiv.appendChild(messageTime);
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            addSearchResults(results, query) {
                const chatContainer = document.getElementById('chatContainer');
                const messageDiv = document.createElement('div');
                
                messageDiv.classList.add('message', 'search-message');
                
                let html = `<div>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ "<b>${query}</b>":</div>`;
                html += `<div class="search-results">`;
                
                results.forEach((result, index) => {
                    html += `
                        <div class="search-result-item">
                            <div class="search-result-title">${result.title}</div>
                            <a href="${result.link}" target="_blank" class="search-result-link">${result.link}</a>
                            <div class="search-result-snippet">${result.snippet}</div>
                            <small>Ù…Ù†Ø¨Ø¹: ${result.source}</small>
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                const messageText = document.createElement('div');
                messageText.innerHTML = html;
                messageDiv.appendChild(messageText);
                
                const messageTime = document.createElement('div');
                messageTime.classList.add('message-time');
                messageTime.textContent = new Date().toLocaleTimeString('fa-IR');
                messageDiv.appendChild(messageTime);
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            showTypingIndicator() {
                document.getElementById('typingIndicator').style.display = 'block';
            }
            
            hideTypingIndicator() {
                document.getElementById('typingIndicator').style.display = 'none';
            }
            
            toggleSettingsPanel(show) {
                document.getElementById("settingsPanel").classList.toggle("active", show);
                document.getElementById("overlay").classList.toggle("active", show);
            }
            
            toggleTheme() {
                this.settings.theme = this.settings.theme === "light" ? "dark" : "light";
                this.applyTheme();
                this.saveSettings();
            }
            
            applyTheme() {
                if (this.settings.theme === "dark") {
                    document.body.classList.add("dark-mode");
                    document.getElementById('themeToggle').textContent = 'â˜€ï¸';
                } else {
                    document.body.classList.remove("dark-mode");
                    document.getElementById('themeToggle').textContent = 'ğŸŒ™';
                }
            }
            
            applySettings() {
                // Ø§Ø¹Ù…Ø§Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² localStorage
                document.getElementById("userName").value = this.settings.userName;
                document.getElementById("chatMode").value = this.settings.chatMode;
                document.getElementById("responseLength").value = this.settings.responseLength;
                document.getElementById("searchEngine").value = this.settings.searchEngine;
                
                this.applyTheme();
            }
            
            saveSettings() {
                localStorage.setItem('chatSettings', JSON.stringify(this.settings));
            }
            
            loadSettings() {
                const savedSettings = localStorage.getItem('chatSettings');
                if (savedSettings) {
                    this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
                }
            }
            
            clearHistory() {
                if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú¯ÙØªÚ¯Ùˆ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                    const chatContainer = document.getElementById('chatContainer');
                    while (chatContainer.children.length > 1) {
                        chatContainer.removeChild(chatContainer.lastChild);
                    }
                    this.nlp.context.conversationHistory = [];
                }
            }
            
            resetSettings() {
                if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                    this.settings = {
                        userName: 'Ú©Ø§Ø±Ø¨Ø±',
                        chatMode: 'normal',
                        responseLength: 'medium',
                        searchEngine: 'duckduckgo',
                        theme: 'light'
                    };
                    this.applySettings();
                    this.saveSettings();
                }
            }
        }

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú†Øªâ€ŒØ¨Ø§Øª Ù‡Ù†Ú¯Ø§Ù…ÛŒ Ú©Ù‡ ØµÙØ­Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯
        document.addEventListener('DOMContentLoaded', () => {
            window.chatManager = new ChatManager();
        });
    </script>
</body>
</html>
