<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>هوش مصنوعی چت فارسی - نسخه موبایل</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6bdf;
            --secondary-color: #6c42f5;
            --accent-color: #ff6b6b;
            --light-bg: #f8f9fa;
            --dark-text: #2d3748;
            --light-text: #718096;
            --card-bg: #ffffff;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            --font-size-base: 1rem;
        }

        /* تم تیره */
        body.dark-mode {
            --light-bg: #1a1a1a;
            --dark-text: #f8f9fa;
            --light-text: #a0a0a0;
            --card-bg: #2d2d2d;
            --gradient: linear-gradient(135deg, #2a3a8f 0%, #3c22a5 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: var(--font-size-base);
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark-text);
            min-height: 100vh;
            padding: 0;
            transition: all 0.3s ease;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #121212 0%, #2d2d2d 100%);
        }

        body.large-font {
            --font-size-base: 1.2rem;
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        header {
            background: var(--gradient);
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
            box-shadow: var(--shadow);
            z-index: 10;
        }

        header h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        header p {
            opacity: 0.9;
            font-size: 0.8rem;
        }

        .header-actions {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 10px;
        }

        .header-actions button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: var(--light-bg);
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: all 0.3s ease;
        }

        .message {
            display: flex;
            max-width: 90%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .ai-message {
            align-self: flex-start;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 8px;
            flex-shrink: 0;
        }

        .user-message .avatar {
            background: var(--accent-color);
            color: white;
        }

        .ai-message .avatar {
            background: var(--primary-color);
            color: white;
        }

        .message-content {
            background: var(--card-bg);
            padding: 12px 16px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            max-width: calc(100% - 60px);
            word-break: break-word;
            hyphens: auto;
            line-height: 1.5;
            transition: all 0.3s ease;
        }

        .user-message .message-content {
            background: #e3f2fd;
            border-top-right-radius: 5px;
        }

        body.dark-mode .user-message .message-content {
            background: #3a4a5d;
        }

        .ai-message .message-content {
            background: white;
            border-top-left-radius: 5px;
        }

        body.dark-mode .ai-message .message-content {
            background: #3d3d3d;
        }

        .message-text {
            margin-bottom: 4px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message-time {
            font-size: 0.65rem;
            color: var(--light-text);
            text-align: left;
        }

        .user-message .message-time {
            text-align: right;
        }

        .input-area {
            padding: 12px;
            background: var(--card-bg);
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        body.dark-mode .input-area {
            border-top: 1px solid #333;
        }

        #user-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            outline: none;
            font-size: var(--font-size-base);
            transition: border-color 0.3s, background 0.3s;
            background: var(--card-bg);
            color: var(--dark-text);
        }

        body.dark-mode #user-input {
            border-color: #444;
            background: #2d2d2d;
        }

        #user-input:focus {
            border-color: var(--primary-color);
        }

        #send-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 46px;
            height: 46px;
            margin-right: 10px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        #send-btn:hover {
            background: var(--secondary-color);
        }

        .typing-indicator {
            display: none;
            padding: 10px 15px;
            background: var(--card-bg);
            border-radius: 18px;
            box-shadow: var(--shadow);
            align-self: flex-start;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--light-text);
            animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        /* منوهای کناری */
        .side-menu {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background: var(--card-bg);
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 100;
            transition: right 0.3s ease;
            padding: 20px;
            overflow-y: auto;
        }

        .side-menu.active {
            right: 0;
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
            color: var(--dark-text);
        }

        body.dark-mode .menu-header {
            border-bottom: 1px solid #333;
        }

        .menu-header h2 {
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .close-menu {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--light-text);
        }

        .menu-section {
            margin-bottom: 25px;
        }

        .menu-section h3 {
            margin-bottom: 12px;
            color: var(--primary-color);
            font-size: 1rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            color: var(--dark-text);
        }

        body.dark-mode .setting-item {
            border-bottom: 1px solid #333;
        }

        .setting-label {
            font-size: 0.9rem;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .history-item {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: var(--light-bg);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            color: var(--dark-text);
        }

        .history-item:hover {
            background: #e9ecef;
        }

        body.dark-mode .history-item:hover {
            background: #3d3d3d;
        }

        .history-date {
            font-size: 0.7rem;
            color: var(--light-text);
            margin-top: 5px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* ریسپانسیو برای تبلت */
        @media (min-width: 768px) {
            .container {
                max-width: 500px;
                margin: 20px auto;
                height: 90vh;
                border-radius: 15px;
                overflow: hidden;
                box-shadow: var(--shadow);
            }
            
            .side-menu {
                width: 350px;
                right: -350px;
            }
        }

        /* اسکرول بار سفارشی */
        .chat-box::-webkit-scrollbar {
            width: 5px;
        }

        .chat-box::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        body.dark-mode .chat-box::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        .chat-box::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        .chat-box::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-actions">
                <button id="history-btn" title="تاریخچه گفتگو">
                    <i class="fas fa-history"></i>
                </button>
                <button id="settings-btn" title="تنظیمات">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
            <h1>هوش مصنوعی چت فارسی</h1>
            <p>نسخه بهینه‌شده برای موبایل</p>
        </header>

        <div class="chat-container">
            <div class="chat-box" id="chat-box">
                <div class="message ai-message">
                    <div class="avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">سلام! من یک هوش مصنوعی پیشرفته فارسی هستم. می‌توانم در مورد برنامه‌نویسی، ریاضیات، تاریخ، علم و خیلی چیزهای دیگر کمک کنم. چگونه می‌توانم به شما کمک کنم؟</div>
                        <div class="message-time">همین حالا</div>
                    </div>
                </div>
                
                <div class="typing-indicator" id="typing-indicator">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <input type="text" id="user-input" placeholder="پیام خود را وارد کنید..." autocomplete="off">
                <button id="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- منوی تاریخچه -->
    <div class="side-menu" id="history-menu">
        <div class="menu-header">
            <h2>تاریخچه گفتگو</h2>
            <button class="close-menu">&times;</button>
        </div>
        <div class="menu-section">
            <div id="history-list">
                <!-- آیتم‌های تاریخچه اینجا نمایش داده می‌شوند -->
            </div>
        </div>
    </div>

    <!-- منوی تنظیمات -->
    <div class="side-menu" id="settings-menu">
        <div class="menu-header">
            <h2>تنظیمات</h2>
            <button class="close-menu">&times;</button>
        </div>
        <div class="menu-section">
            <h3>تنظیمات نمایش</h3>
            <div class="setting-item">
                <span class="setting-label">تم تیره</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="dark-mode">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span class="setting-label">فونت بزرگتر</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="large-font">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <div class="menu-section">
            <h3>تنظیمات اعلان‌ها</h3>
            <div class="setting-item">
                <span class="setting-label">صدای اعلان</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="notification-sound" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span class="setting-label">لرزش</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="vibration" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <div class="menu-section">
            <h3>تنظیمات حریم خصوصی</h3>
            <div class="setting-item">
                <span class="setting-label">ذخیره تاریخچه</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="save-history" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <button id="clear-history-btn" style="background: var(--accent-color); color: white; border: none; padding: 8px 15px; border-radius: 5px; width: 100%; cursor: pointer;">
                    پاک کردن همه تاریخچه
                </button>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>

    <!-- صدای اعلان -->
    <audio id="notification-audio" src="https://www.soundjay.com/buttons/beep-07.mp3"></audio>

    <script>
        // پایگاه داده دانش گسترش یافته برای هوش مصنوعی باهوش‌تر
        const knowledgeBase = {
            greetings: {
                patterns: ["سلام", "درود", "سلامتی", "علیک", "hello", "hi", "صبح بخیر", "عصر بخیر", "شب بخیر"],
                responses: [
                    "سلام! چطور می‌تونم کمک تون کنم؟ 😊",
                    "درود بر شما! چه کمکی از دستم برمیاد؟",
                    "سلام! خوشحالم که باهات گفتگو می‌کنم. امروز چه سوالی داری؟"
                ]
            },
            farewells: {
                patterns: ["خداحافظ", "بای", "خدانگهدار", "goodbye", "bye", "فعلا", "بدرود"],
                responses: [
                    "خداحافظ! امیدوارم باز هم ببینمت. 🌸",
                    "بدرود! همیشه در خدمت شما هستم.",
                    "خدانگهدار! روز خوبی داشته باشید. ☀️"
                ]
            },
            thanks: {
                patterns: ["ممنون", "متشکرم", "مرسی", "thanks", "thank you", "دست مریزاد"],
                responses: [
                    "خواهش می‌کنم! خوشحالم که تونستم کمک کنم. 😊",
                    "قابل نداشت! همیشه خوشحال می‌شم کمکت کنم.",
                    "خواهش می‌کنم! برای من افتخاره که می‌تونم کمکتون کنم."
                ]
            },
            math: {
                patterns: ["محاسبه", "ریاضی", "جمع", "تفریق", "ضرب", "تقسیم", "بعلاوه", "منهای", "ریشه", "توان", "معادله"],
                responses: [] // پاسخ‌ها در generateResponse مدیریت می‌شوند
            },
            time: {
                patterns: ["ساعت", "زمان", "چند شب", "چند صبح", "امروز چندمه", "تاریخ"],
                responses: [
                    `هم اکنون ساعت ${new Date().toLocaleTimeString('fa-IR')} است.`,
                    `امروز ${new Date().toLocaleDateString('fa-IR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} است.`,
                    `الان ${new Date().toLocaleTimeString('fa-IR')} و تاریخ امروز ${new Date().toLocaleDateString('fa-IR')} است.`
                ]
            },
            programming: {
                patterns: ["برنامه نویسی", "کد", "جاوا اسکریپت", "پایتون", "html", "css", "جاوا", "سی شارپ", "الگوریتم", "فانکشن", "متغیر", "حلقه"],
                responses: [
                    "در مورد برنامه‌نویسی می‌تونم کمک کنم! مثلاً برای نوشتن یک فانکشن ساده در جاوااسکریپت: function add(a, b) { return a + b; }",
                    "اگر سوال خاصی در مورد کد داری، بگو تا راهنمایی کنم. مثلاً چطور یک آرایه رو سورت کنیم؟",
                    "برنامه‌نویسی یکی از تخصص‌های منه! بپرس در مورد هر زبانی که می‌خوای، مثل پایتون: print('Hello World!')"
                ]
            },
            history: {
                patterns: ["تاریخ", "جنگ جهانی", "ایران باستان", "انقلاب", "شاه", "هخامنشیان"],
                responses: [
                    "تاریخ ایران باستان شامل سلسله‌هایی مثل هخامنشیان است که توسط کوروش کبیر تأسیس شد.",
                    "جنگ جهانی دوم از ۱۹۳۹ تا ۱۹۴۵ طول کشید و بیش از ۷۰ میلیون نفر کشته شدند.",
                    "در مورد چه دوره تاریخی می‌خوای بدونم؟"
                ]
            },
            science: {
                patterns: ["علم", "فیزیک", "شیمی", "زیست", "ستاره شناسی", "انرژی", "اتم", "ژنتیک"],
                responses: [
                    "در فیزیک، قانون نیوتن می‌گه F = m*a. جزئیات بیشتری می‌خوای؟",
                    "شیمی عناصر جدول تناوبی رو بررسی می‌کنه، مثل هیدروژن که سبک‌ترین عنصر است.",
                    "زیست‌شناسی به مطالعه زندگی می‌پردازه، مثل DNA که کد ژنتیکی ماست."
                ]
            },
            weather: {
                patterns: ["آب و هوا", "هوا", "باران", "برف", "دما"],
                responses: [
                    "متأسفانه دسترسی به داده‌های واقعی ندارم، اما می‌تونم بگم که در تهران معمولاً تابستون‌ها گرم است!",
                    "برای پیش‌بینی دقیق، از اپ‌های هواشناسی استفاده کن، اما اگر سوال کلی داری بپرس."
                ]
            },
            jokes: {
                patterns: ["جوک", "لطیفه", "خنده", "بگو جوک"],
                responses: [
                    "چرا کامپیوترها سرما نمی‌خورن؟ چون ویندوز دارن! 😄",
                    "یک ایرانی به هوش مصنوعی می‌گه: 'جوک بگو'، هوش می‌گه: 'زندگی!' 😂",
                    "چرا کتاب ریاضی ناراحته؟ چون پر از مسئله است! 📚"
                ]
            },
            advice: {
                patterns: ["نصیحت", "راهنمایی", "مشاوره", "چطور", "چگونه"],
                responses: [
                    "برای موفقیت، همیشه یادگیری رو ادامه بده و اهداف کوچک تعیین کن.",
                    "اگر در مورد زندگی مشاوره می‌خوای، بگو جزئیات تا بهتر کمک کنم.",
                    "بهترین نصیحت: 'سلامت باش و شاد!' 🌟"
                ]
            }
        };

        // ذخیره‌سازی تنظیمات در localStorage
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('persianAI_settings')) || {};
            document.getElementById('dark-mode').checked = settings.darkMode || false;
            document.getElementById('large-font').checked = settings.largeFont || false;
            document.getElementById('notification-sound').checked = settings.notificationSound !== false;
            document.getElementById('vibration').checked = settings.vibration !== false;
            document.getElementById('save-history').checked = settings.saveHistory !== false;

            applyDarkMode();
            applyLargeFont();
        }

        function saveSettings() {
            const settings = {
                darkMode: document.getElementById('dark-mode').checked,
                largeFont: document.getElementById('large-font').checked,
                notificationSound: document.getElementById('notification-sound').checked,
                vibration: document.getElementById('vibration').checked,
                saveHistory: document.getElementById('save-history').checked
            };
            localStorage.setItem('persianAI_settings', JSON.stringify(settings));
        }

        // اعمال تم تیره
        function applyDarkMode() {
            if (document.getElementById('dark-mode').checked) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
        }

        // اعمال فونت بزرگتر
        function applyLargeFont() {
            if (document.getElementById('large-font').checked) {
                document.body.classList.add('large-font');
            } else {
                document.body.classList.remove('large-font');
            }
        }

        // پخش صدا و لرزش
        function notify() {
            if (document.getElementById('notification-sound').checked) {
                document.getElementById('notification-audio').play();
            }
            if (document.getElementById('vibration').checked && 'vibrate' in navigator) {
                navigator.vibrate(200);
            }
        }

        // ذخیره‌سازی تاریخچه گفتگو
        let chatHistory = [];
        let currentSession = [];

        // بارگذاری تاریخچه از localStorage
        try {
            const savedHistory = localStorage.getItem('persianAI_chatHistory');
            if (savedHistory) {
                chatHistory = JSON.parse(savedHistory);
            }
        } catch (e) {
            console.error('خطا در بارگذاری تاریخچه:', e);
            chatHistory = [];
        }

        // عناصر DOM
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');
        const historyBtn = document.getElementById('history-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const historyMenu = document.getElementById('history-menu');
        const settingsMenu = document.getElementById('settings-menu');
        const overlay = document.getElementById('overlay');
        const closeMenuButtons = document.querySelectorAll('.close-menu');
        const historyList = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const darkModeToggle = document.getElementById('dark-mode');
        const largeFontToggle = document.getElementById('large-font');
        const notificationSoundToggle = document.getElementById('notification-sound');
        const vibrationToggle = document.getElementById('vibration');
        const saveHistoryToggle = document.getElementById('save-history');

        // نمایش تاریخچه گفتگو
        function renderChatHistory() {
            chatBox.innerHTML = '';
            
            // اضافه کردن پیام خوشامدگویی اگر تاریخچه خالی است
            if (currentSession.length === 0) {
                const welcomeMsg = document.createElement('div');
                welcomeMsg.className = 'message ai-message';
                welcomeMsg.innerHTML = `
                    <div class="avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-text">سلام! من یک هوش مصنوعی پیشرفته فارسی هستم. می‌توانم در مورد برنامه‌نویسی، ریاضیات، تاریخ، علم و خیلی چیزهای دیگر کمک کنم. چگونه می‌توانم به شما کمک کنم؟</div>
                        <div class="message-time">همین حالا</div>
                    </div>
                `;
                chatBox.appendChild(welcomeMsg);
                return;
            }
            
            currentSession.forEach(msg => {
                displayMessage(msg.text, msg.sender, msg.time, false);
            });
            
            // اسکرول به پایین
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // ذخیره تاریخچه در localStorage
        function saveToHistory(message, sender) {
            if (!document.getElementById('save-history').checked) return;

            const messageData = {
                text: message,
                sender: sender,
                time: new Date().toLocaleTimeString('fa-IR')
            };
            
            currentSession.push(messageData);
            
            // فقط ۱۰ تا از آخرین گفتگوها را نگه دار
            if (chatHistory.length >= 10) {
                chatHistory.shift();
            }
            
            // اضافه کردن session جدید به تاریخچه (اما فقط اگر جلسه جدید باشد)
            if (sender === 'user' && currentSession.length === 1 || sender === 'ai') {
                chatHistory[chatHistory.length - 1] = {
                    session: [...currentSession],
                    date: new Date().toLocaleDateString('fa-IR'),
                    id: Date.now()
                };
            } else if (sender === 'user') {
                chatHistory.push({
                    session: [...currentSession],
                    date: new Date().toLocaleDateString('fa-IR'),
                    id: Date.now()
                });
            }
            
            try {
                localStorage.setItem('persianAI_chatHistory', JSON.stringify(chatHistory));
                renderHistoryList();
            } catch (e) {
                console.error('خطا در ذخیره تاریخچه:', e);
            }
        }

        // نمایش لیست تاریخچه
        function renderHistoryList() {
            historyList.innerHTML = '';
            
            if (chatHistory.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: var(--light-text); padding: 20px;">هیچ تاریخچه‌ای موجود نیست</p>';
                return;
            }
            
            // نمایش تاریخچه به صورت معکوس (جدیدترین اول)
            [...chatHistory].reverse().forEach((session, index) => {
                const firstMessage = session.session[0]?.text || 'گفتگو جدید';
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div>${firstMessage.substring(0, 30)}${firstMessage.length > 30 ? '...' : ''}</div>
                    <div class="history-date">${session.date}</div>
                `;
                historyItem.addEventListener('click', () => {
                    loadHistorySession(chatHistory.length - 1 - index);
                    closeMenus();
                });
                historyList.appendChild(historyItem);
            });
        }

        // بارگذاری یک session از تاریخچه
        function loadHistorySession(index) {
            if (index >= 0 && index < chatHistory.length) {
                currentSession = [...chatHistory[index].session];
                renderChatHistory();
            }
        }

        // پاک کردن تاریخچه
        function clearHistory() {
            if (confirm('آیا از پاک کردن همه تاریخچه گفتگو مطمئن هستید؟')) {
                chatHistory = [];
                currentSession = [];
                try {
                    localStorage.removeItem('persianAI_chatHistory');
                } catch (e) {
                    console.error('خطا در پاک کردن تاریخچه:', e);
                }
                renderHistoryList();
                renderChatHistory();
            }
        }

        // باز کردن منو
        function openMenu(menu) {
            menu.classList.add('active');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // اگر منوی تاریخچه است، لیست را رندر کن
            if (menu.id === 'history-menu') {
                renderHistoryList();
            }
        }

        // بستن منوها
        function closeMenus() {
            historyMenu.classList.remove('active');
            settingsMenu.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // تشخیص قصد کاربر با دقت بیشتر
        function detectIntent(message) {
            const lowerMessage = message.toLowerCase().replace(/[^\w\s]/gi, '');
            
            for (const [intent, data] of Object.entries(knowledgeBase)) {
                for (const pattern of data.patterns) {
                    if (lowerMessage.includes(pattern.toLowerCase())) {
                        return intent;
                    }
                }
            }
            
            return "unknown";
        }

        // تولید پاسخ پیشرفته‌تر
        function generateResponse(intent, userMessage) {
            if (knowledgeBase[intent] && knowledgeBase[intent].responses.length > 0) {
                const responses = knowledgeBase[intent].responses;
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            // مدیریت محاسبات ریاضی پیشرفته‌تر
            if (intent === 'math' || userMessage.match(/[\d+\-*/^sqrt()]+/)) {
                try {
                    let expr = userMessage.replace(/ریشه/g, 'Math.sqrt').replace(/توان/g, '**').replace(/[^0-9+\-*/^()sqrtMath. ]/g, '');
                    const result = eval(expr);
                    return `نتیجه محاسبه: ${result}. اگر معادله پیچیده‌تری داری، بگو تا حل کنم!`;
                } catch (e) {
                    return "متأسفم، نمی‌توانم این محاسبه را انجام دهم. لطفاً فرمول را واضح‌تر بنویس.";
                }
            }
            
            // مدیریت برنامه‌نویسی با مثال‌های بیشتر
            if (intent === 'programming') {
                if (userMessage.includes('جاوا اسکریپت')) {
                    return "در جاوااسکریپت، برای ایجاد یک آرایه: let arr = [1, 2, 3]; و برای سورت: arr.sort(); سوال بیشتری داری؟";
                } else if (userMessage.includes('پایتون')) {
                    return "در پایتون، برای چاپ: print('سلام دنیا') و برای لیست: my_list = [1, 2, 3]. چه کد دیگه‌ای نیاز داری؟";
                } else {
                    return "برنامه‌نویسی رو دوست دارم! مثلاً الگوریتم جستجوی باینری رو می‌خوای توضیح بدم؟";
                }
            }
            
            // پاسخ پیش فرض هوشمندانه‌تر
            const responses = [
                `جالب است! "${userMessage}" رو بررسی کردم، اما دقیق متوجه نشدم. می‌تونی جزئیات بیشتری بدی؟`,
                "من در حال یادگیری‌ام و می‌تونم در مورد موضوعات مختلفی حرف بزنم. مثلاً در مورد علم، تاریخ یا حتی جوک! 😊",
                "این سوال خوبیه! اگر در مورد برنامه‌نویسی، ریاضی یا هر چیز دیگه‌ای باشه، می‌تونم کمک کنم.",
                "متأسفم اگر پاسخ کاملی ندارم، اما بیایم با هم فکر کنیم: چه جنبه‌ای از این موضوع مهمه؟",
                "برای پاسخ دقیق‌تر، می‌تونم شبیه‌سازی کنم. مثلاً اگر سوال برنامه‌نویسی باشه، کد نمونه می‌دم!"
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // نمایش پیام در چت
        function displayMessage(text, sender, time = null, save = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            
            const avatarIcon = document.createElement('i');
            avatarIcon.className = sender === 'user' ? 'fas fa-user' : 'fas fa-robot';
            avatar.appendChild(avatarIcon);
            
            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';
            
            const messageText = document.createElement('div');
            messageText.className = 'message-text';
            messageText.textContent = text;
            
            const messageTime = document.createElement('div');
            messageTime.className = 'message-time';
            messageTime.textContent = time || new Date().toLocaleTimeString('fa-IR');
            
            messageContent.appendChild(messageText);
            messageContent.appendChild(messageTime);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            chatBox.appendChild(messageDiv);
            
            // اسکرول به پایین
            chatBox.scrollTop = chatBox.scrollHeight;
            
            // ذخیره در تاریخچه اگر فعال باشد
            if (save) {
                saveToHistory(text, sender);
            }

            // پخش اعلان اگر پیام AI باشد
            if (sender === 'ai') {
                notify();
            }
        }

        // نمایش نشانگر تایپ
        function showTypingIndicator() {
            typingIndicator.style.display = 'block';
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // پنهان کردن نشانگر تایپ
        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }

        // پردازش پیام کاربر و تولید پاسخ
        function sendMessage() {
            const message = userInput.value.trim();
            
            if (!message) return;
            
            // نمایش پیام کاربر
            displayMessage(message, 'user');
            userInput.value = '';
            
            // غیرفعال کردن ورودی تا دریافت پاسخ
            userInput.disabled = true;
            sendBtn.disabled = true;
            
            // نمایش نشانگر تایپ
            showTypingIndicator();
            
            // تاخیر برای طبیعی‌تر شدن (بین 1 تا 2 ثانیه)
            setTimeout(() => {
                try {
                    // تشخیص قصد کاربر و تولید پاسخ
                    const intent = detectIntent(message);
                    const response = generateResponse(intent, message);
                    
                    // پنهان کردن نشانگر تایپ و نمایش پاسخ
                    hideTypingIndicator();
                    displayMessage(response, 'ai');
                } catch (error) {
                    hideTypingIndicator();
                    displayMessage('متأسفانه در پردازش پیام شما خطایی رخ داده است. لطفاً دوباره امتحان کنید.', 'ai');
                    console.error('Error:', error);
                } finally {
                    // فعال کردن مجدد ورودی
                    userInput.disabled = false;
                    sendBtn.disabled = false;
                    userInput.focus();
                }
            }, Math.random() * 1000 + 1000);
        }

        // مقداردهی اولیه
        function initialize() {
            // بارگذاری تنظیمات
            loadSettings();

            // رویدادهای کلیک
            historyBtn.addEventListener('click', () => openMenu(historyMenu));
            settingsBtn.addEventListener('click', () => openMenu(settingsMenu));
            overlay.addEventListener('click', closeMenus);
            closeMenuButtons.forEach(btn => btn.addEventListener('click', closeMenus));
            clearHistoryBtn.addEventListener('click', clearHistory);

            // رویدادهای تنظیمات
            darkModeToggle.addEventListener('change', () => {
                applyDarkMode();
                saveSettings();
            });
            largeFontToggle.addEventListener('change', () => {
                applyLargeFont();
                saveSettings();
            });
            notificationSoundToggle.addEventListener('change', saveSettings);
            vibrationToggle.addEventListener('change', saveSettings);
            saveHistoryToggle.addEventListener('change', saveSettings);

            // امکان ارسال با کلید Enter
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // رویداد کلیک برای دکمه ارسال
            sendBtn.addEventListener('click', sendMessage);

            // بارگذاری اولیه
            renderChatHistory();
            renderHistoryList();
            userInput.focus();
        }

        // شروع برنامه زمانی که DOM کاملاً لود شده
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
