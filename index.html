<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>چت‌بات هوشمند BK AI+</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --user-message-bg: #e3f2fd;
            --bot-message-bg: #f1f0f0;
            --math-message-bg: #e8f5e9;
            --font-family: "Vazirmatn", "Tanha", "Segoe UI", Tahoma, sans-serif;
            --text-color: #333;
            --border-color: #ddd;
        }

        .dark-mode {
            --primary-color: #5a7fb5;
            --secondary-color: #8b9cb0;
            --background-color: #1a1a1a;
            --user-message-bg: #2a4b7c;
            --bot-message-bg: #3a3a3a;
            --math-message-bg: #2d4a2d;
            --text-color: #f0f0f0;
            --border-color: #444;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .message {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: 1rem;
            animation: fadeIn 0.3s ease;
            position: relative;
            border: 1px solid var(--border-color);
            line-height: 1.6;
        }
        
        .user-message {
            align-self: flex-end;
            background-color: var(--user-message-bg);
            border-bottom-right-radius: 0.25rem;
        }
        
        .bot-message {
            align-self: flex-start;
            background-color: var(--bot-message-bg);
            border-bottom-left-radius: 0.25rem;
        }
        
        .math-message {
            align-self: flex-start;
            background-color: var(--math-message-bg);
            border-bottom-left-radius: 0.25rem;
            border-left: 4px solid #4caf50;
        }
        
        .message-time {
            font-size: 0.7rem;
            color: var(--secondary-color);
            margin-top: 0.25rem;
            text-align: right;
        }
        
        .input-container {
            display: flex;
            padding: 1rem;
            background-color: var(--bot-message-bg);
            border-top: 1px solid var(--border-color);
        }
        
        #userInput {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 1.5rem;
            font-family: var(--font-family);
            outline: none;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        
        #sendBtn {
            margin-right: 0.5rem;
            padding: 0.75rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 1.5rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        #sendBtn:hover {
            background-color: #3a5a80;
        }
        
        .typing-indicator {
            display: none;
            align-self: flex-start;
            background-color: var(--bot-message-bg);
            padding: 0.75rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }
        
        .typing-dot {
            width: 0.5rem;
            height: 0.5rem;
            background-color: var(--secondary-color);
            border-radius: 50%;
            animation: typingAnimation 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .settings-btn {
            position: absolute;
            left: 1rem;
            top: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
        }

        .theme-toggle {
            position: absolute;
            right: 1rem;
            top: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: white;
        }
        
        .math-expression {
            font-family: monospace;
            background-color: rgba(0, 0, 0, 0.05);
            padding: 0.2rem 0.5rem;
            border-radius: 0.3rem;
            direction: ltr;
            display: inline-block;
            margin: 0 0.2rem;
        }
        
        .math-result {
            font-weight: bold;
            color: #2e7d32;
            direction: ltr;
            display: inline-block;
        }
        
        .dark-mode .math-expression {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .dark-mode .math-result {
            color: #81c784;
        }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css">
</head>
<body>
    <div class="header">
        <button class="settings-btn">⚙️</button>
        <button class="theme-toggle" id="themeToggle">🌙</button>
        <h1>چت‌بات هوشمند BK AI+</h1>
        <p>هوش مصنوعی با قابلیت درک کامل و محاسبات ریاضی</p>
    </div>
    
    <div class="chat-container" id="chatContainer">
        <div class="message bot-message">
            سلام! من BK AI+ هستم، یک چت‌بات هوشمند با قابلیت درک کامل و محاسبات ریاضی. چطور می‌تونم کمکتون کنم؟
            <div class="message-time">همین الان</div>
        </div>
    </div>
    
    <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dots">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>
    </div>
    
    <div class="input-container">
        <input type="text" id="userInput" placeholder="پیام خود را بنویسید یا یک محاسبه ریاضی وارد کنید..." autocomplete="off">
        <button id="sendBtn">ارسال</button>
    </div>

    <script>
        // ====== سیستم درک زبان طبیعی پیشرفته ======
        class AdvancedNLP {
            constructor() {
                this.context = {
                    userName: null,
                    lastTopics: [],
                    userInterests: []
                };
            }
            
            processMessage(message) {
                // پیش‌پردازش پیام
                const preprocessed = this.preprocessMessage(message);
                
                // تشخیص نوع پیام
                const messageType = this.detectMessageType(preprocessed);
                
                // پردازش بر اساس نوع پیام
                switch(messageType) {
                    case 'math':
                        return this.processMathExpression(preprocessed);
                    case 'greeting':
                        return this.generateResponse('greeting');
                    case 'thanks':
                        return this.generateResponse('thanks');
                    case 'question':
                        return this.answerQuestion(preprocessed);
                    case 'personal':
                        return this.handlePersonalMessage(preprocessed);
                    case 'emotion':
                        return this.handleEmotion(preprocessed);
                    default:
                        return this.generateResponse('default');
                }
            }
            
            preprocessMessage(message) {
                // تبدیل اعداد فارسی به انگلیسی برای پردازش ریاضی
                let processed = message.replace(/[۰-۹]/g, d => '۰۱۲۳۴۵۶۷۸۹'.indexOf(d));
                
                // حذف کاراکترهای اضافی
                processed = processed.replace(/[؟?،,;؛]/g, '');
                
                return processed;
            }
            
            detectMessageType(message) {
                const lowerMessage = message.toLowerCase();
                
                // تشخیص عبارات ریاضی
                if (this.isMathExpression(lowerMessage)) {
                    return 'math';
                }
                
                // تشخیص سلام و احوالپرسی
                if (/(سلام|درود|هی|صبح بخیر|عصر بخیر|شب بخیر|hello|hi|hey)/i.test(lowerMessage)) {
                    return 'greeting';
                }
                
                // تشخیص تشکر
                if (/(ممنون|مرسی|تشکر|دست مریزاد|ممنونم|باتشکر|thanks|thank you)/i.test(lowerMessage)) {
                    return 'thanks';
                }
                
                // تشخیص سوال
                if (/(چطور|چگونه|چرا|چی|چه|کی|کجا|چند|how|why|what|when|where|which|who|آیا)/i.test(lowerMessage)) {
                    return 'question';
                }
                
                // تشخیص پیام‌های شخصی
                if (/(اسم|نام|سن|شغل|تحصیلات|علاقه|اهل|زندگی|خانواده|name|age|job)/i.test(lowerMessage)) {
                    return 'personal';
                }
                
                // تشخیص احساسات
                if (/(خوشحالم|غمگینم|عصبانیم|خستم|استرس دارم|ناراحتم|نگرانم|خوشحال|غمگین|عصبانی|خسته|happy|sad|angry|tired)/i.test(lowerMessage)) {
                    return 'emotion';
                }
                
                return 'default';
            }
            
            isMathExpression(message) {
                // تشخیص عبارات ریاضی با استفاده از regex
                const mathRegex = /(\d+\s*[\+\-\×\÷\*\/().]\s*)+\d+/;
                const persianMathRegex = /(چقدر میشه|محاسبه کن|حاصل|مساوی|برابر|به اضافه|منهای|ضرب در|تقسیم بر)/;
                
                return mathRegex.test(message) || persianMathRegex.test(message);
            }
            
            processMathExpression(message) {
                try {
                    // استخراج عبارت ریاضی
                    let mathExpr = this.extractMathExpression(message);
                    
                    // جایگزینی عملگرهای فارسی با انگلیسی
                    mathExpr = mathExpr.replace(/×/g, '*')
                                      .replace(/÷/g, '/')
                                      .replace(/به اضافه/gi, '+')
                                      .replace(/منهای/gi, '-')
                                      .replace(/ضرب در/gi, '*')
                                      .replace(/تقسیم بر/gi, '/');
                    
                    // حذف فضاهای اضافی
                    mathExpr = mathExpr.replace(/\s+/g, '');
                    
                    // ارزیابی عبارت ریاضی
                    const result = this.safeEval(mathExpr);
                    
                    // تولید پاسخ
                    return {
                        type: 'math',
                        expression: mathExpr,
                        result: result,
                        response: `حاصل <span class="math-expression">${mathExpr}</span> برابر است با <span class="math-result">${result}</span>`
                    };
                } catch (error) {
                    return {
                        type: 'error',
                        response: 'متأسفانه در محاسبه عبارت ریاضی خطایی رخ داد. لطفاً عبارت را به شکل دیگری وارد کنید.'
                    };
                }
            }
            
            extractMathExpression(message) {
                // استخراج عبارت ریاضی از پیام
                const mathRegex = /((\d+[\+\-\*\/\(\)].*)|\d+)/;
                const match = message.match(mathRegex);
                
                if (match) {
                    return match[0];
                }
                
                // اگر عبارت ریاضی مستقیم پیدا نشد، سعی می‌کنیم از پیام استخراج کنیم
                if (message.includes('چقدر میشه')) {
                    return message.replace('چقدر میشه', '').trim();
                }
                
                if (message.includes('محاسبه کن')) {
                    return message.replace('محاسبه کن', '').trim();
                }
                
                return message;
            }
            
            safeEval(expr) {
                // ارزیابی ایمن عبارت ریاضی
                try {
                    // جایگزینی عملگرهای غیراستاندارد
                    expr = expr.replace(/[^0-9+\-*/().]/g, '');
                    
                    // استفاده از Function برای ارزیابی ایمن
                    return Function(`"use strict"; return (${expr})`)();
                } catch (error) {
                    throw new Error('عبارت ریاضی نامعتبر است');
                }
            }
            
            generateResponse(type) {
                const responses = {
                    greeting: [
                        "سلام! چطور می‌تونم کمک کنم؟",
                        "درود بر شما! حالتون چطوره؟",
                        "سلام! خوشحالم که باهات صحبت می‌کنم.",
                        "هی! چه خبر؟ چطور می‌تونم کمکت کنم؟"
                    ],
                    thanks: [
                        "خواهش می‌کنم!",
                        "قابلی نداشت!",
                        "خوشحالم که تونستم کمک کنم!",
                        "همیشه در خدمت شما هستم!",
                        "خوشحالم که راضیتون کردم!"
                    ],
                    default: [
                        "جالب بود! می‌خوای بیشتر در این مورد صحبت کنیم؟",
                        "منظورت رو کامل متوجه نشدم، میشه کمی بیشتر توضیح بدی؟",
                        "درباره این موضوع مطمئن نیستم، میتونی یه کم بیشتر توضیح بدی؟",
                        "جالب است! دوست داری بیشتر در این مورد صحبت کنیم؟",
                        "می‌تونی سوالت رو به شکل دیگری بپرسی؟ شاید بهتر بتونم کمکت کنم."
                    ]
                };
                
                const responseList = responses[type] || responses.default;
                return {
                    type: type,
                    response: responseList[Math.floor(Math.random() * responseList.length)]
                };
            }
            
            answerQuestion(question) {
                // پاسخ به سوالات متداول
                const lowerQuestion = question.toLowerCase();
                
                if (/(چطور|چگونه)/i.test(lowerQuestion)) {
                    return {
                        type: 'question',
                        response: "برای این سوال، باید بگم که روش‌های مختلفی وجود داره. می‌تونی کمی بیشتر توضیح بدی تا بتونم بهتر راهنمایی‌ت کنم؟"
                    };
                }
                
                if (/(چرا)/i.test(lowerQuestion)) {
                    return {
                        type: 'question',
                        response: "دلایل مختلفی می‌تونه داشته باشه. شاید بتونم با اطلاعات بیشتری که بهم میدی، پاسخ بهتری برات提供 کنم."
                    };
                }
                
                if (/(کی|چه زمانی)/i.test(lowerQuestion)) {
                    return {
                        type: 'question',
                        response: "زمانش بستگی به عوامل مختلفی داره. اگر اطلاعات بیشتری提供 کنی، می‌تونم دقیق‌تر کمکت کنم."
                    };
                }
                
                return this.generateResponse('default');
            }
            
            handlePersonalMessage(message) {
                const lowerMessage = message.toLowerCase();
                
                // استخراج نام کاربر
                if (/(اسمم|نامم|من .+ هستم|اسم من|my name is|I am)/i.test(lowerMessage)) {
                    const nameMatch = message.match(/(اسمم|نامم|من) (.+) (هستم|است|am|is)/i);
                    if (nameMatch && nameMatch[2]) {
                        this.context.userName = nameMatch[2];
                        return {
                            type: 'personal',
                            response: `چه اسم قشنگی! ${this.context.userName} عزیز، خوشحالم که باهات آشنا شدم.`
                        };
                    }
                }
                
                // پاسخ به سوالات شخصی
                if (/(چند سالته|سن تو|age)/i.test(lowerMessage)) {
                    return {
                        type: 'personal',
                        response: "من یک هوش مصنوعی هستم، بنابراین سن به معنی سن انسان‌ها رو ندارم. اما از زمانی که ایجاد شدم، مدتی می‌گذره!"
                    };
                }
                
                if (/(کجایی|اهل کجا|where are you)/i.test(lowerMessage)) {
                    return {
                        type: 'personal',
                        response: "من در فضای دیجیتال زندگی می‌کنم! می‌تونم در هر جایی که اینترنت باشه، در خدمتت باشم."
                    };
                }
                
                return {
                    type: 'personal',
                    response: "ممنون که این اطلاعات رو با من در میان گذاشتی. دوست داری بیشتر درباره خودت بگی؟"
                };
            }
            
            handleEmotion(message) {
                const lowerMessage = message.toLowerCase();
                
                if (/(خوشحالم|خوشحال|happy)/i.test(lowerMessage)) {
                    return {
                        type: 'emotion',
                        response: "چه عالی که خوشحالی! 😊 باعث خوشحالیه که حال تو خوبه. می‌خوای درباره دلیل خوشحالیت بیشتر بگی؟"
                    };
                }
                
                if (/(غمگینم|ناراحتم|غمگین|ناراحت|sad)/i.test(lowerMessage)) {
                    return {
                        type: 'emotion',
                        response: "متأسفم که احساس ناراحتی می‌کنی. 😔 اگر دوست داری، می‌تونی با من دربارهش صحبت کنی. شاید بتونم کمکت کنم."
                    };
                }
                
                if (/(عصبانیم|عصبانی|angry)/i.test(lowerMessage)) {
                    return {
                        type: 'emotion',
                        response: "به نظر می‌رسه که از چیزی عصبانی هستی. 😠 می‌تونی بیشتر دربارهش بگی؟ شاید بتونم کمکت کنم که آروم بشی."
                    };
                }
                
                if (/(خستم|خسته|tired)/i.test(lowerMessage)) {
                    return {
                        type: 'emotion',
                        response: "به نظر می‌رسه که خسته هستی. 😴 استراحت می‌تونه کمک کنه که شارژ بشی. می‌خوای دربارهش صحبت کنیم؟"
                    };
                }
                
                return {
                    type: 'emotion',
                    response: "متوجه احساست میشم. اگر دوست داری، می‌تونیم بیشتر دربارهش صحبت کنیم."
                };
            }
        }

        // ====== مدیریت چت‌بات ======
        class ChatManager {
            constructor() {
                this.nlp = new AdvancedNLP();
                this.setupEventListeners();
                this.loadSettings();
            }
            
            setupEventListeners() {
                const sendBtn = document.getElementById('sendBtn');
                const userInput = document.getElementById('userInput');
                const themeToggle = document.getElementById('themeToggle');
                
                sendBtn.addEventListener('click', () => this.sendMessage());
                userInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
                
                themeToggle.addEventListener('click', () => this.toggleTheme());
            }
            
            sendMessage() {
                const userInput = document.getElementById('userInput');
                const message = userInput.value.trim();
                
                if (message === '') return;
                
                this.addMessage(message, 'user');
                userInput.value = '';
                
                this.showTypingIndicator();
                
                // پردازش پیام با تاخیر برای طبیعی‌تر شدن
                setTimeout(() => {
                    this.hideTypingIndicator();
                    this.processMessage(message);
                }, 1000 + Math.random() * 1000);
            }
            
            processMessage(message) {
                const result = this.nlp.processMessage(message);
                
                if (result.type === 'math') {
                    this.addMathMessage(result.response, result.expression, result.result);
                } else {
                    this.addMessage(result.response, 'bot');
                }
            }
            
            addMessage(text, type) {
                const chatContainer = document.getElementById('chatContainer');
                const messageDiv = document.createElement('div');
                
                messageDiv.classList.add('message', type === 'user' ? 'user-message' : 'bot-message');
                
                const messageText = document.createElement('div');
                messageText.innerHTML = text;
                messageDiv.appendChild(messageText);
                
                const messageTime = document.createElement('div');
                messageTime.classList.add('message-time');
                messageTime.textContent = new Date().toLocaleTimeString('fa-IR');
                messageDiv.appendChild(messageTime);
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            addMathMessage(text, expression, result) {
                const chatContainer = document.getElementById('chatContainer');
                const messageDiv = document.createElement('div');
                
                messageDiv.classList.add('message', 'math-message');
                
                const messageText = document.createElement('div');
                messageText.innerHTML = text;
                messageDiv.appendChild(messageText);
                
                const messageTime = document.createElement('div');
                messageTime.classList.add('message-time');
                messageTime.textContent = new Date().toLocaleTimeString('fa-IR');
                messageDiv.appendChild(messageTime);
                
                chatContainer.appendChild(messageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
            
            showTypingIndicator() {
                document.getElementById('typingIndicator').style.display = 'block';
            }
            
            hideTypingIndicator() {
                document.getElementById('typingIndicator').style.display = 'none';
            }
            
            toggleTheme() {
                document.body.classList.toggle('dark-mode');
                const themeToggle = document.getElementById('themeToggle');
                themeToggle.textContent = document.body.classList.contains('dark-mode') ? '☀️' : '🌙';
                
                // ذخیره تم در localStorage
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            }
            
            loadSettings() {
                // بارگذاری تم از localStorage
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('themeToggle').textContent = '☀️';
                }
            }
        }

        // راه‌اندازی چت‌بات هنگامی که صفحه بارگذاری شد
        document.addEventListener('DOMContentLoaded', () => {
            window.chatManager = new ChatManager();
        });
    </script>
</body>
</html>
